name: App Version Updates

on:
  workflow_dispatch:
    inputs:
      inshot_version:
        description: "InShot App Version"
        default: "1.91.1"
        required: false
      update_inshot:
        description: "Update InShot"
        type: boolean
        default: false
      appstorepp_version:
        description: "AppStore++ App Version"
        default: "1.0.3"
        required: false
      update_appstorepp:
        description: "Update AppStore++"
        type: boolean
        default: false
      itorrent_version:
        description: "iTorrent App Version"
        default: "2.1.0"
        required: false
      update_itorrent:
        description: "Update iTorrent"
        type: boolean
        default: false
      livecontainer_version:
        description: "LiveContainer App Version"
        default: "3.6.1"
        required: false
      update_livecontainer:
        description: "Update LiveContainer"
        type: boolean
        default: false
      reface_version:
        description: "Reface App Version"
        default: "5.27.0"
        required: false
      update_reface:
        description: "Update Reface"
        type: boolean
        default: false
      change_description:
        description: "Custom commit message (optional)"
        default: ""
        required: false
      update_workflow_defaults:
        description: "Update workflow default versions (Requires PAT)"
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  repository-sync:
    name: "Sync App Versions"
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: "Run Update Script"
        id: update-files
        env:
          INSHOT_VERSION: ${{ github.event.inputs.inshot_version }}
          UPDATE_INSHOT: ${{ github.event.inputs.update_inshot }}
          APPSTOREPP_VERSION: ${{ github.event.inputs.appstorepp_version }}
          UPDATE_APPSTOREPP: ${{ github.event.inputs.update_appstorepp }}
          ITORRENT_VERSION: ${{ github.event.inputs.itorrent_version }}
          UPDATE_ITORRENT: ${{ github.event.inputs.update_itorrent }}
          LIVECONTAINER_VERSION: ${{ github.event.inputs.livecontainer_version }}
          UPDATE_LIVECONTAINER: ${{ github.event.inputs.update_livecontainer }}
          REFACE_VERSION: ${{ github.event.inputs.reface_version }}
          UPDATE_REFACE: ${{ github.event.inputs.update_reface }}
          UPDATE_WORKFLOW_DEFAULTS: ${{ github.event.inputs.update_workflow_defaults }}
        run: |
          chmod +x scripts/update_apps.sh
          ./scripts/update_apps.sh

      - name: "Commit and push changes"
        if: steps.update-files.outputs.updated_apps
        env:
          CUSTOM_DESC: ${{ github.event.inputs.change_description }}
        run: |
          set -e
          
          if [[ -n "$CUSTOM_DESC" ]]; then
            COMMIT_MSG="$CUSTOM_DESC"
          else
            COMMIT_MSG="App Version Updates: ${steps.update-files.outputs.updated_apps}"
          fi
          
          # Optimization: Removed apps.json
          git add sidestore.json trollapps.json
          
          if git diff --staged --quiet; then
            echo "::notice::No changes to commit"
          else
            git commit -m "$COMMIT_MSG"
            # SECURITY FIX: Pull before push to avoid race conditions
            git pull --rebase origin main
            git push origin HEAD
          fi

      - name: "Generate summary"
        if: always()
        run: |
          echo "## ðŸ“¦ App Version Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.update-files.outputs.updated_apps }}" ]; then
            echo "Updated: ${{ steps.update-files.outputs.updated_apps }}" >> $GITHUB_STEP_SUMMARY
          fi
