name: Bulk IPA Updates

on:
  workflow_dispatch:
    inputs:
      update_spotify:
        description: "Update Spotify"
        type: boolean
        default: false
      spotify_ipa_version:
        description: "Spotify IPA Version:"
        default: "9.0.96"
      spotify_tweak_version:
        description: "Spotify Tweak Version:"
        default: "v6.2.2"
      update_youtube:
        description: "Update YouTube"
        type: boolean
        default: false
      youtube_ipa_version:
        description: "YouTube IPA Version:"
        default: "20.45.3"
      youtube_tweak_version:
        description: "YouTube Tweak Version:"
        default: "v5.2b4"
      update_x:
        description: "Update X"
        type: boolean
        default: false
      x_ipa_version:
        description: "X IPA Version:"
        default: "11.38.1"
      x_tweak_version:
        description: "X Tweak Version:"
        default: "v5.2"
      change_description:
        description: "Custom commit message (optional)"
        default: ""

jobs:
  repository-sync:
    name: "Sync App Repository"
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Setup environment"
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          echo "CURRENT_DATE=$(date -u +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: "Update repository files"
        id: update-files
        env:
          UPDATE_SPOTIFY: ${{ github.event.inputs.update_spotify }}
          SPOTIFY_IPA: ${{ github.event.inputs.spotify_ipa_version }}
          SPOTIFY_TWEAK: ${{ github.event.inputs.spotify_tweak_version }}
          UPDATE_YOUTUBE: ${{ github.event.inputs.update_youtube }}
          YOUTUBE_IPA: ${{ github.event.inputs.youtube_ipa_version }}
          YOUTUBE_TWEAK: ${{ github.event.inputs.youtube_tweak_version }}
          UPDATE_X: ${{ github.event.inputs.update_x }}
          X_IPA: ${{ github.event.inputs.x_ipa_version }}
          X_TWEAK: ${{ github.event.inputs.x_tweak_version }}
        run: |
          set -e
          
          # App configuration mapping
          declare -A APP_CONFIG
          APP_CONFIG[spotify]="EeveeSpotify:com.spotify.client:$UPDATE_SPOTIFY:$SPOTIFY_IPA:$SPOTIFY_TWEAK"
          APP_CONFIG[youtube]="YTLite:com.google.ios.youtube:$UPDATE_YOUTUBE:$YOUTUBE_IPA:$YOUTUBE_TWEAK"
          APP_CONFIG[x]="X (NeoFreeBird):com.atebits.Tweetie2:$UPDATE_X:$X_IPA:$X_TWEAK"
          
          build_download_url() {
            local app_name="$1"
            local tweak_version="$2"
            case "$app_name" in
              "EeveeSpotify") 
                echo "https://github.com/OofMini/eeveespotifyreborn/releases/download/New/EeveeSpotify.ipa"
                ;;
              "YTLite") 
                local clean_version="${tweak_version#v}"
                echo "https://github.com/OofMini/YTLite/releases/download/New/YouTubePlus_${clean_version}.ipa"
                ;;
              "X (NeoFreeBird)") 
                echo "https://github.com/OofMini/tweak/releases/download/New/NeoFreeBird-sideloaded.ipa"
                ;;
              *) 
                echo "Unknown app: $app_name" >&2
                return 1
                ;;
            esac
          }
          
          validate_json_files() {
            echo "Validating JSON files..."
            for file in sidestore.json feather.json trollapps.json; do
              if [ ! -f "$file" ]; then
                echo "‚ùå Missing file: $file"
                return 1
              fi
              if ! jq -e '.apps' "$file" >/dev/null 2>&1; then
                echo "‚ùå Invalid JSON structure in $file"
                return 1
              fi
              echo "‚úÖ $file is valid"
            done
          }
          
          update_json_file() {
            local file="$1"
            local app_name="$2"
            local bundle_id="$3"
            local ipa_version="$4"
            local download_url="$5"
            local temp_file="${file}.tmp"
            
            echo "Updating $file for $app_name..."
            
            case "$file" in
              "sidestore.json")
                jq --arg app "$app_name" \
                   --arg bundle "$bundle_id" \
                   --arg version "$ipa_version" \
                   --arg url "$download_url" \
                   --arg date "$CURRENT_DATE" \
                   '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                    (.versions[0].version = $version | .versions[0].downloadURL = $url | .versions[0].date = $date)' \
                   "$file" > "$temp_file"
                ;;
              "feather.json")  
                jq --arg app "$app_name" \
                   --arg bundle "$bundle_id" \
                   --arg version "$ipa_version" \
                   --arg url "$download_url" \
                   --arg date "$CURRENT_DATE" \
                   '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                    (.version = $version | .downloadURL = $url | .versionDate = $date |
                     .versions[0].version = $version | .versions[0].downloadURL = $url | .versions[0].date = $date)' \
                   "$file" > "$temp_file"
                ;;
              "trollapps.json")
                jq --arg app "$app_name" \
                   --arg bundle "$bundle_id" \
                   --arg version "$ipa_version" \
                   --arg url "$download_url" \
                   '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                    (.version = $version | .downloadURL = $url)' \
                   "$file" > "$temp_file"
                ;;
            esac
            
            if [ -f "$temp_file" ] && jq . "$temp_file" >/dev/null 2>&1; then
              mv "$temp_file" "$file"
              echo "‚úÖ Successfully updated $file"
            else
              echo "‚ùå Failed to update $file - invalid JSON output"
              [ -f "$temp_file" ] && rm -f "$temp_file"
              return 1
            fi
          }
          
          # Main execution
          echo "Starting repository update process..."
          validate_json_files
          
          updated_apps=()
          updated_versions=()
          
          for app_key in "${!APP_CONFIG[@]}"; do
            IFS=':' read -r app_name bundle_id should_update ipa_version tweak_version <<< "${APP_CONFIG[$app_key]}"
            
            if [ "$should_update" != "true" ]; then
              echo "‚ÑπÔ∏è Skipping $app_name - update not requested"
              continue
            fi
            
            echo "üîÑ Processing $app_name update..."
            download_url=$(build_download_url "$app_name" "$tweak_version")
            echo "Download URL: $download_url"
            
            for file in sidestore.json feather.json trollapps.json; do
              if ! update_json_file "$file" "$app_name" "$bundle_id" "$ipa_version" "$download_url"; then
                echo "‚ùå Failed to update $file for $app_name"
                exit 1
              fi
            done
            
            updated_apps+=("$app_name")
            updated_versions+=("${app_key}:${ipa_version}:${tweak_version}")
            echo "‚úÖ Successfully updated $app_name to IPA $ipa_version, Tweak $tweak_version"
          done
          
          # Set outputs
          if [ ${#updated_apps[@]} -gt 0 ]; then
            echo "updated_apps=${updated_apps[*]}" >> $GITHUB_OUTPUT
            echo "updated_versions=${updated_versions[*]}" >> $GITHUB_OUTPUT
            echo "‚úÖ All updates completed successfully"
          else
            echo "‚ÑπÔ∏è No apps selected for update"
          fi
          
          # Final validation
          echo "Final validation of JSON files..."
          for file in sidestore.json feather.json trollapps.json; do
            if jq . "$file" >/dev/null 2>&1; then
              echo "‚úÖ $file passed final validation"
            else
              echo "‚ùå $file failed final validation"
              exit 1
            fi
          done

      - name: "Update web files and workflow defaults"
        if: steps.update-files.outputs.updated_versions
        run: |
          set -e
          UPDATED_VERSIONS="${{ steps.update-files.outputs.updated_versions }}"
          
          if [ -z "$UPDATED_VERSIONS" ]; then
            echo "No versions to update"
            exit 0
          fi
          
          # Update index.html with version information
          if [ -f "index.html" ]; then
            echo "Updating index.html..."
            for version_pair in $UPDATED_VERSIONS; do
              IFS=':' read -r app ipa_version tweak_version <<< "$version_pair"
              
              case "$app" in
                "spotify")
                  sed -i "/id: 'eeveespotify'/,/},/{
                    s/version: '[0-9][0-9.]*',/version: '$ipa_version',/
                    s|Spotify IPA [0-9][0-9.]*, EeveeSpotify v[0-9a-z.]*|Spotify IPA $ipa_version, EeveeSpotify $tweak_version|
                  }" "index.html"
                  ;;
                "youtube")
                  sed -i "/id: 'ytlite'/,/},/{
                    s/version: '[0-9][0-9.]*',/version: '$ipa_version',/
                    s|YouTube IPA [0-9][0-9.]*, YTLite v[0-9a-z.]*|YouTube IPA $ipa_version, YTLite $tweak_version|
                  }" "index.html"
                  ;;
                "x")
                  sed -i "/id: 'neofreebird'/,/},/{
                    s/version: '[0-9][0-9.]*',/version: '$ipa_version',/
                    s|X IPA [0-9][0-9.]*, NeoFreeBird v[0-9a-z.]*|X IPA $ipa_version, NeoFreeBird $tweak_version|
                  }" "index.html"
                  ;;
              esac
            done
            echo "‚úÖ Updated index.html"
          else
            echo "‚ö†Ô∏è index.html not found"
          fi
          
          # Update workflow defaults
          workflow_file=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | head -1)
          if [ -f "$workflow_file" ]; then
            echo "Updating workflow defaults in $workflow_file..."
            for version_pair in $UPDATED_VERSIONS; do
              IFS=':' read -r app ipa_version tweak_version <<< "$version_pair"
              
              # Update IPA version default
              sed -i "/${app}_ipa_version:/,/default:/s/default: \"[^\"]*\"/default: \"$ipa_version\"/" "$workflow_file"
              
              # Update tweak version default
              sed -i "/${app}_tweak_version:/,/default:/s/default: \"[^\"]*\"/default: \"$tweak_version\"/" "$workflow_file"
            done
            echo "‚úÖ Updated workflow defaults"
          else
            echo "‚ö†Ô∏è Workflow file not found"
          fi

      - name: "Commit and push changes"
        if: steps.update-files.outputs.updated_apps
        env:
          UPDATED_APPS: ${{ steps.update-files.outputs.updated_apps }}
        run: |
          set -e
          
          # Generate commit message
          if [ -n "${{ github.event.inputs.change_description }}" ]; then
            commit_msg="${{ github.event.inputs.change_description }}"
          else
            commit_msg="Repository Sync: Updated app versions"
            if [ -n "$UPDATED_APPS" ]; then
              commit_msg="$commit_msg\n\nUpdated apps:"
              for app in $UPDATED_APPS; do
                commit_msg="$commit_msg\n‚Ä¢ $app"
              done
            fi
            commit_msg="$commit_msg\n\nAutomated update via GitHub Actions"
          fi
          
          # Configure git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add modified files
          git add sidestore.json feather.json trollapps.json index.html
          workflow_file=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | head -1)
          if [ -f "$workflow_file" ]; then
            git add "$workflow_file"
          fi
          
          if ! git diff --staged --quiet; then
            echo -e "$commit_msg" | git commit -F -
            git push
            echo "‚úÖ Changes committed and pushed"
          else
            echo "‚ÑπÔ∏è No changes to commit"
          fi

      - name: "Update summary"
        if: always()
        env:
          UPDATED_APPS: ${{ steps.update-files.outputs.updated_apps }}
          UPDATED_VERSIONS: ${{ steps.update-files.outputs.updated_versions }}
        run: |
          {
            echo "## Repository Update Summary"
            echo ""
            
            if [ -n "$UPDATED_APPS" ]; then
              echo "### Apps Updated:"
              for app in $UPDATED_APPS; do
                echo "- $app"
              done
            else
              echo "### No apps were updated"
            fi
            
            echo ""
            echo "### Files Modified:"
            echo "- sidestore.json"
            echo "- feather.json"  
            echo "- trollapps.json"
            echo "- index.html"
            
            if [ -n "$UPDATED_VERSIONS" ]; then
              echo "- workflow (updated defaults)"
              echo ""
              echo "### Version Updates:"
              for version_pair in $UPDATED_VERSIONS; do
                IFS=':' read -r app ipa_version tweak_version <<< "$version_pair"
                echo "- ${app^}: IPA $ipa_version, Tweak $tweak_version"
              done
            fi
            
            echo ""
            echo "---"
            echo "Automated repository management"
          } >> $GITHUB_STEP_SUMMARY