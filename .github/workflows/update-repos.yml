- name: "Update web content and workflow defaults"
        if: steps.update-files.outputs.updated_versions
        run: |
          set -e
          UPDATED_VERSIONS_STR="${{ steps.update-files.outputs.updated_versions }}"
          [ -z "$UPDATED_VERSIONS_STR" ] && exit 0
          
          IFS=' ' read -ra VERSION_PAIRS <<< "$UPDATED_VERSIONS_STR"
          
          # Update index.html
          if [ -f "index.html" ]; then
            for version_pair in "${VERSION_PAIRS[@]}"; do
              IFS=':' read -ra PARTS <<< "$version_pair"
              APP="${PARTS[0]}"
              IPA_VERSION="${PARTS[1]}"
              TWEAK_VERSION="${PARTS[2]}"
              
              case "$APP" in
                "spotify")
                  sed -i -e "/id: 'eeveespotify'/,/},/{s/version: '[0-9][0-9.]*',/version: '$IPA_VERSION',/}" \
                         -e "/id: 'eeveespotify'/,/},/{s|Spotify IPA [0-9][0-9.]*, EeveeSpotify v[0-9a-z.]*|Spotify IPA $IPA_VERSION, EeveeSpotify $TWEAK_VERSION|}" \
                         "index.html"
                  ;;
                "youtube")
                  sed -i -e "/id: 'ytlite'/,/},/{s/version: '[0-9][0-9.]*',/version: '$IPA_VERSION',/}" \
                         -e "/id: 'ytlite'/,/},/{s|YouTube IPA [0-9][0-9.]*, YTLite v[0-9a-z.]*|YouTube IPA $IPA_VERSION, YTLite $TWEAK_VERSION|}" \
                         "index.html"
                  ;;
                "x")
                  sed -i -e "/id: 'neofreebird'/,/},/{s/version: '[0-9][0-9.]*',/version: '$IPA_VERSION',/}" \
                         -e "/id: 'neofreebird'/,/},/{s|X IPA [0-9][0-9.]*, NeoFreeBird v[0-9a-z.]*|X IPA $IPA_VERSION, NeoFreeBird $TWEAK_VERSION|}" \
                         "index.html"
                  ;;
              esac
            done
          fi
          
          # Update workflow defaults - SIMPLIFIED AND DIRECT APPROACH
          WORKFLOW_FILE=".github/workflows/update-repos.yml"
          
          if [ -f "$WORKFLOW_FILE" ]; then
            echo "Updating workflow defaults in $WORKFLOW_FILE..."
            
            # Create a temporary copy
            cp "$WORKFLOW_FILE" "${WORKFLOW_FILE}.tmp"
            
            for version_pair in "${VERSION_PAIRS[@]}"; do
              IFS=':' read -ra PARTS <<< "$version_pair"
              APP="${PARTS[0]}"
              IPA_VERSION="${PARTS[1]}"
              TWEAK_VERSION="${PARTS[2]}"
              
              echo "Updating $APP defaults to IPA: $IPA_VERSION, Tweak: $TWEAK_VERSION"
              
              # Use Python for reliable text processing
              python3 -c "
import re
import sys

filename = '.github/workflows/update-repos.yml.tmp'
app = '$APP'
ipa_version = '$IPA_VERSION'
tweak_version = '$TWEAK_VERSION'

with open(filename, 'r') as f:
    content = f.read()

# Replace IPA version - look for the exact pattern
ipa_pattern = f'{app}_ipa_version:'
if ipa_pattern in content:
    # Find and replace the default value after the pattern
    content = re.sub(
        f'({app}_ipa_version:[\\s\\S]*?default: [\"\\'])([^\"\\']*)([\"\\'])',
        f'\\\\g<1>{ipa_version}\\\\g<3>',
        content
    )

# Replace tweak version - look for the exact pattern  
tweak_pattern = f'{app}_tweak_version:'
if tweak_pattern in content:
    content = re.sub(
        f'({app}_tweak_version:[\\s\\S]*?default: [\"\\'])([^\"\\']*)([\"\\'])',
        f'\\\\g<1>{tweak_version}\\\\g<3>',
        content
    )

with open(filename, 'w') as f:
    f.write(content)
"
            done
            
            # Replace the original file
            mv "${WORKFLOW_FILE}.tmp" "$WORKFLOW_FILE"
            echo "âœ… Workflow defaults updated using Python"
            
            # Show the changes
            echo "Updated defaults:"
            grep -A 2 -E "(spotify|youtube|x)_(ipa|tweak)_version" "$WORKFLOW_FILE" || true
          fi