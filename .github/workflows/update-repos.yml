name: Bulk IPA Updates

on:
  workflow_dispatch:
    inputs:
      update_spotify:
        description: "Update Spotify"
        type: boolean
        default: false
      spotify_ipa_version:
        description: "Spotify IPA Version:"
        default: "9.0.91"
      spotify_tweak_version:
        description: "Spotify Tweak Version:"
        default: "v6.2"

      update_youtube:
        description: "Update YouTube"
        type: boolean
        default: false
      youtube_ipa_version:
        description: "YouTube IPA Version:"
        default: "20.44.2"
      youtube_tweak_version:
        description: "YouTube Tweak Version:"
        default: "v5.2b4"

      update_twitter:
        description: "Update Twitter/X"
        type: boolean
        default: false
      twitter_ipa_version:
        description: "Twitter IPA Version:"
        default: "11.36"
      twitter_tweak_version:
        description: "Twitter Tweak Version:"
        default: "v5.2"

      change_description:
        description: "Custom commit message (optional)"
        default: ""

jobs:
  repository-sync:
    name: Sync app repository
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate and update JSONs
        id: update-files
        shell: bash
        run: |
          set -euo pipefail

          # Install dependencies
          sudo apt-get update -y
          sudo apt-get install -y jq

          CURRENT_DATE="$(date -u +"%Y-%m-%d")"
          echo "current_date=${CURRENT_DATE}" >> "$GITHUB_OUTPUT"

          files=(sidestore.json feather.json trollapps.json)

          # Ensure files exist and valid JSON
          for f in "${files[@]}"; do
            [[ -f "$f" ]] || { echo "$f - File not found"; exit 1; }
            jq empty "$f" >/dev/null || { echo "$f - Invalid JSON syntax"; exit 1; }
          done

          # Validate structural requirements
          for f in "${files[@]}"; do
            jq -e '.apps | type == "array"' "$f" >/dev/null || { echo "$f - Missing required 'apps' array"; exit 1; }
            app_count="$(jq '.apps | length' "$f")"
            if [[ "$app_count" -eq 0 ]]; then
              echo "$f - 'apps' array is empty"
            else
              echo "$f - Valid structure with $app_count apps"
            fi
          done

          build_download_info() {
            local app_name="$1" tweak_version="$2"
            case "$app_name" in
              "EeveeSpotify")
                # Static filename currently used
                echo "https://github.com/OofMini/eeveespotifyreborn/releases/download/New/EeveeSpotify.ipa"
                ;;
              "YTLite")
                # Includes tweak version in filename
                echo "https://github.com/OofMini/YTLite/releases/download/New/YouTubePlus_${tweak_version}.ipa"
                ;;
              "X (NeoFreeBird)")
                echo "https://github.com/OofMini/tweak/releases/download/New/NeoFreeBird-sideloaded.ipa"
                ;;
              *)
                echo "Unknown app: $app_name" >&2
                return 1
                ;;
            esac
          }

          update_app_in_file() {
            local file="$1" app_name="$2" bundle_id="$3" ipa_version="$4" tweak_version="$5"
            echo "Updating $app_name in $file..."

            local download_url
            download_url="$(build_download_info "$app_name" "$tweak_version")" || exit 1

            local desc
            case "$app_name" in
              "EeveeSpotify")
                desc="Tweaked Spotify with premium features unlocked, no ads, and enhanced playback. Spotify IPA ${ipa_version}, EeveeSpotify ${tweak_version}."
                ;;
              "YTLite")
                desc="Tweaked YouTube with background playback, no ads, and picture-in-picture. YouTube IPA ${ipa_version}, YTLite ${tweak_version}."
                ;;
              "X (NeoFreeBird)")
                desc="Tweaked Twitter/X with premium features and more. Twitter IPA ${ipa_version}, NeoFreeBird ${tweak_version}."
                ;;
              *)
                desc="$(jq -r --arg app "$app_name" --arg bundle "$bundle_id" '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)).localizedDescription // "Tweaked application with enhanced features."' "$file")"
                ;;
            esac

            tmp="${file}.tmp"
            case "$file" in
              "sidestore.json")
                jq --arg app "$app_name" \
                   --arg bundle "$bundle_id" \
                   --arg version "$ipa_version" \
                   --arg url "$download_url" \
                   --arg desc "$desc" \
                   --arg date "$CURRENT_DATE" '
                     (.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |=
                     (.versions |= (
                        if . == null or . == [] then
                          [{"version": $version, "downloadURL": $url, "date": $date}]
                        else
                          .[0].version = $version |
                          .[0].downloadURL = $url |
                          .[0].date = $date |
                          .
                        end
                      )
                      | .localizedDescription = $desc)
                   ' "$file" > "$tmp"
                ;;
              "feather.json")
                jq --arg app "$app_name" \
                   --arg bundle "$bundle_id" \
                   --arg version "$ipa_version" \
                   --arg url "$download_url" \
                   --arg desc "$desc" \
                   --arg date "$CURRENT_DATE" '
                     (.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |=
                     (.version = $version
                      | .downloadURL = $url
                      | .versionDate = $date
                      | .versions |= (
                          if . == null or . == [] then
                            [{"version": $version, "downloadURL": $url, "date": $date, "size": (0)}]
                          else
                            .[0].version = $version
                            | .[0].downloadURL = $url
                            | .[0].date = $date
                            | .[0].size = (.[] | .size? // 0)
                            | .
                          end
                        )
                      | .localizedDescription = $desc)
                   ' "$file" > "$tmp"
                ;;
              "trollapps.json")
                jq --arg app "$app_name" \
                   --arg bundle "$bundle_id" \
                   --arg version "$ipa_version" \
                   --arg url "$download_url" \
                   --arg desc "$desc" '
                     (.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |=
                     (.version = $version
                      | .downloadURL = $url
                      | .localizedDescription = $desc)
                   ' "$file" > "$tmp"
                ;;
              *)
                echo "Unknown file: $file" >&2
                exit 1
                ;;
            esac

            jq empty "$tmp" >/dev/null || { echo "Temp file invalid for $file"; rm -f "$tmp"; exit 1; }
            mv "$tmp" "$file"
            echo "Updated $app_name in $file"
          }

          UPDATED_APPS=()
          UPDATED_VERSIONS=()

          if [[ "${{ github.event.inputs.update_spotify }}" == "true" ]]; then
            UPDATED_APPS+=("EeveeSpotify")
            UPDATED_VERSIONS+=("spotify:${{ github.event.inputs.spotify_ipa_version }}:${{ github.event.inputs.spotify_tweak_version }}")
            for f in "${files[@]}"; do
              update_app_in_file "$f" "EeveeSpotify" "com.spotify.client" \
                "${{ github.event.inputs.spotify_ipa_version }}" \
                "${{ github.event.inputs.spotify_tweak_version }}"
            done
          fi

          if [[ "${{ github.event.inputs.update_youtube }}" == "true" ]]; then
            UPDATED_APPS+=("YTLite")
            UPDATED_VERSIONS+=("youtube:${{ github.event.inputs.youtube_ipa_version }}:${{ github.event.inputs.youtube_tweak_version }}")
            for f in "${files[@]}"; do
              update_app_in_file "$f" "YTLite" "com.google.ios.youtube" \
                "${{ github.event.inputs.youtube_ipa_version }}" \
                "${{ github.event.inputs.youtube_tweak_version }}"
            done
          fi

          if [[ "${{ github.event.inputs.update_twitter }}" == "true" ]]; then
            UPDATED_APPS+=("X (NeoFreeBird)")
            UPDATED_VERSIONS+=("twitter:${{ github.event.inputs.twitter_ipa_version }}:${{ github.event.inputs.twitter_tweak_version }}")
            for f in "${files[@]}"; do
              update_app_in_file "$f" "X (NeoFreeBird)" "com.atebits.Tweetie2" \
                "${{ github.event.inputs.twitter_ipa_version }}" \
                "${{ github.event.inputs.twitter_tweak_version }}"
            done
          fi

          # Output updated arrays for later steps
          if [[ ${#UPDATED_APPS[@]} -gt 0 ]]; then
            echo "updated_apps=$(printf "%s " "${UPDATED_APPS[@]}" | sed 's/ $//')" >> "$GITHUB_OUTPUT"
            echo "updated_versions=$(printf "%s " "${UPDATED_VERSIONS[@]}" | sed 's/ $//')" >> "$GITHUB_OUTPUT"
          else
            echo "No apps selected for update"
          fi

          # Final JSON validation
          for f in "${files[@]}"; do
            jq empty "$f" >/dev/null || { echo "$f - Invalid JSON after updates"; exit 1; }
          done

      - name: Update index.html and workflow defaults
        if: steps.update-files.outputs.updated_versions
        shell: bash
        run: |
          set -euo pipefail

          UPDATED_VERSIONS_STR="${{ steps.update-files.outputs.updated_versions }}"

          # Update index.html if present
          if [[ -f "index.html" ]]; then
            cp index.html index.html.tmp
            IFS=' ' read -r -a VERSION_PAIRS <<< "$UPDATED_VERSIONS_STR"
            for pair in "${VERSION_PAIRS[@]}"; do
              IFS=':' read -r app ipa tweak <<< "$pair"
              case "$app" in
                spotify)
                  # Replace version and description safely
                  sed -i -E "s/version: '9\.[0-9.]*',/version: '${ipa}',/g" index.html.tmp
                  sed -i -E "s|Spotify v9\.[0-9.]*, EeveeSpotify v[0-9a-z.]*|Spotify IPA ${ipa}, EeveeSpotify ${tweak}|g" index.html.tmp
                  ;;
                youtube)
                  sed -i -E "s/version: '20\.[0-9.]*',/version: '${ipa}',/g" index.html.tmp
                  sed -i -E "s|Youtube v20\.[0-9.]*, YTLite v[0-9a-z.]*|YouTube IPA ${ipa}, YTLite ${tweak}|g" index.html.tmp
                  ;;
                twitter)
                  sed -i -E "s/version: '11\.[0-9.]*',/version: '${ipa}',/g" index.html.tmp
                  sed -i -E "s|X v11\.[0-9.]*, NeoFreeBird v[0-9a-z.]*|Twitter IPA ${ipa}, NeoFreeBird ${tweak}|g" index.html.tmp
                  ;;
              esac
            done
            mv index.html.tmp index.html
            echo "index.html updated"
          else
            echo "Warning: index.html not found; skipping UI update"
          fi

          # Update workflow default inputs (keep GUI intact)
          WORKFLOW_FILE=".github/workflows/${{ github.workflow }}.yml"
          [[ -f "$WORKFLOW_FILE" ]] || WORKFLOW_FILE=".github/workflows/main.yml"

          if [[ -f "$WORKFLOW_FILE" ]]; then
            cp "$WORKFLOW_FILE" "${WORKFLOW_FILE}.tmp"
            IFS=' ' read -r -a VERSION_PAIRS <<< "$UPDATED_VERSIONS_STR"
            for pair in "${VERSION_PAIRS[@]}"; do
              IFS=':' read -r app ipa tweak <<< "$pair"
              # Update defaults under the corresponding input keys without altering descriptions
              # IPA default
              sed -i -E "s|(^\s+${app}_ipa_version:\s*$\n(\s+description: .*$\n)?\s+default: ).*$|\1\"${ipa}\"|m" "${WORKFLOW_FILE}.tmp"
              # Tweak default
              sed -i -E "s|(^\s+${app}_tweak_version:\s*$\n(\s+description: .*$\n)?\s+default: ).*$|\1\"${tweak}\"|m" "${WORKFLOW_FILE}.tmp"
            done
            mv "${WORKFLOW_FILE}.tmp" "$WORKFLOW_FILE"
            echo "Workflow defaults updated"
          else
            echo "Warning: workflow file not found; skipping defaults update"
          fi

      - name: Commit and push changes
        if: steps.update-files.outputs.updated_apps
        shell: bash
        run: |
          set -euo pipefail

          if [[ -n "${{ github.event.inputs.change_description }}" ]]; then
            COMMIT_MSG="${{ github.event.inputs.change_description }}"
          else
            COMMIT_MSG="Repository Sync: Updated app versions across all sources"
            UPDATED_APPS_STR="${{ steps.update-files.outputs.updated_apps }}"
            if [[ -n "$UPDATED_APPS_STR" ]]; then
              COMMIT_MSG+="

Updated apps:"
              IFS=' ' read -r -a arr <<< "$UPDATED_APPS_STR"
              for app in "${arr[@]}"; do
                COMMIT_MSG+="
â€¢ $app"
              done
            fi
            COMMIT_MSG+="

Automated update via GitHub Actions"
          fi

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Stage changes
          git add sidestore.json feather.json trollapps.json || true
          [[ -f index.html ]] && git add index.html || true

          if [[ -f ".github/workflows/${{ github.workflow }}.yml" ]]; then
            git add ".github/workflows/${{ github.workflow }}.yml"
          elif [[ -f ".github/workflows/main.yml" ]]; then
            git add ".github/workflows/main.yml"
          fi

          # Commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "$COMMIT_MSG"
            git push
            echo "Changes committed and pushed"
          fi

      - name: Update summary
        shell: bash
        run: |
          {
            echo "## Repository Update Summary"
            echo
            echo "### Apps Updated:"
            UPDATED_APPS_STR="${{ steps.update-files.outputs.updated_apps }}"
            if [[ -n "$UPDATED_APPS_STR" ]]; then
              IFS=' ' read -r -a arr <<< "$UPDATED_APPS_STR"
              for app in "${arr[@]}"; do
                echo "- $app"
              done
            else
              echo "No apps were updated (all toggles were off or no changes detected)"
            fi
            echo
            echo "### Files Updated:"
            echo "- sidestore.json"
            echo "- feather.json"
            echo "- trollapps.json"
            [[ -f index.html ]] && echo "- index.html"
            if [[ -n "${{ steps.update-files.outputs.updated_versions }}" ]]; then
              echo "- workflow.yml (updated defaults)"
              echo
              echo "### New Default Versions Set:"
              UPDATED_VERSIONS_STR="${{ steps.update-files.outputs.updated_versions }}"
              IFS=' ' read -r -a vp <<< "$UPDATED_VERSIONS_STR"
              for version_pair in "${vp[@]}"; do
                IFS=':' read -r app ipa tweak <<< "$version_pair"
                # Capitalize label for display
                label="$(tr '[:lower:]' '[:upper:]' <<< "${app:0:1}")${app:1}"
                echo "- ${label}: IPA ${ipa}, Tweak ${tweak}"
              done
            fi
            echo
            echo "---"
            echo "Automated repository management"
          } >> "$GITHUB_STEP_SUMMARY"
