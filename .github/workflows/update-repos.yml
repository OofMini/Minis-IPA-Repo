name: Bulk IPA Updates

on:
  workflow_dispatch:
    inputs:
      # Existing Apps (3 apps √ó 3 inputs = 9 inputs) - Keep these separate for backward compatibility
      spotify_ipa_version:
        description: "Spotify IPA Version"
        default: "9.1.0"
        required: false
      spotify_tweak_version:
        description: "Spotify Tweak Version"
        default: "v6.2.2"
        required: false
      update_spotify:
        description: "Update Spotify"
        type: boolean
        default: true
        
      youtube_ipa_version:
        description: "YouTube IPA Version"
        default: "20.47.3"
        required: false
      youtube_tweak_version:
        description: "YouTube Tweak Version"
        default: "v5.2b4"
        required: false
      update_youtube:
        description: "Update YouTube"
        type: boolean
        default: true
        
      x_ipa_version:
        description: "X IPA Version"
        default: "11.43.1"
        required: false
      x_tweak_version:
        description: "X Tweak Version"
        default: "v5.2"
        required: false
      update_x:
        description: "Update X"
        type: boolean
        default: true
        
      # New Apps Configuration (5 apps in 2 inputs instead of 15)
      new_apps_config:
        description: |
          JSON config for new apps. Format:
          {
            "inshot": {"ipa": "0.0.0", "tweak": "v0.0.0", "update": false},
            "appstorepp": {"ipa": "0.0.0", "tweak": "v0.0.0", "update": false},
            "itorrent": {"ipa": "0.0.0", "tweak": "v0.0.0", "update": false},
            "livecontainer": {"ipa": "0.0.0", "tweak": "v0.0.0", "update": false},
            "reface": {"ipa": "0.0.0", "tweak": "v0.0.0", "update": false}
          }
        default: '{
          "inshot": {"ipa": "0.0.0", "tweak": "v0.0.0", "update": false},
          "appstorepp": {"ipa": "0.0.0", "tweak": "v0.0.0", "update": false},
          "itorrent": {"ipa": "0.0.0", "tweak": "v0.0.0", "update": false},
          "livecontainer": {"ipa": "0.0.0", "tweak": "v0.0.0", "update": false},
          "reface": {"ipa": "0.0.0", "tweak": "v0.0.0", "update": false}
        }'
        required: false
        
      # Global Inputs (2 inputs)
      change_description:
        description: "Custom commit message (optional)"
        default: ""
        required: false
      update_workflow_defaults:
        description: "Update workflow default versions"
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  repository-sync:
    name: "Sync App Repository"
    runs-on: ubuntu-latest
    
    steps:
      # STEP 1: Checkout repository (required, cannot be merged)
      - name: "Checkout repository"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      # STEP 2: Setup dependencies, validate inputs, and configure Git (merged 3 steps into 1)
      - name: "Setup dependencies and validate inputs"
        env:
          # Pass existing app inputs as environment variables
          SPOTIFY_IPA_VERSION: ${{ github.event.inputs.spotify_ipa_version }}
          SPOTIFY_TWEAK_VERSION: ${{ github.event.inputs.spotify_tweak_version }}
          UPDATE_SPOTIFY: ${{ github.event.inputs.update_spotify }}
          
          YOUTUBE_IPA_VERSION: ${{ github.event.inputs.youtube_ipa_version }}
          YOUTUBE_TWEAK_VERSION: ${{ github.event.inputs.youtube_tweak_version }}
          UPDATE_YOUTUBE: ${{ github.event.inputs.update_youtube }}
          
          X_IPA_VERSION: ${{ github.event.inputs.x_ipa_version }}
          X_TWEAK_VERSION: ${{ github.event.inputs.x_tweak_version }}
          UPDATE_X: ${{ github.event.inputs.update_x }}
          
          # New apps config as JSON string
          NEW_APPS_CONFIG: ${{ github.event.inputs.new_apps_config }}
          
          UPDATE_WORKFLOW_DEFAULTS: ${{ github.event.inputs.update_workflow_defaults }}
          CHANGE_DESCRIPTION: ${{ github.event.inputs.change_description }}
        run: |
          set -e
          
          echo "üì¶ Installing dependencies..."
          sudo apt-get update -qq
          sudo apt-get install -y jq
          echo "‚úÖ Dependencies installed"
          
          echo "üîç Validating inputs..."
          
          # Function to validate version format
          validate_version() {
            local version="$1"
            local app_name="$2"
            local version_type="$3"
            
            if [[ -z "$version" ]]; then
              echo "::error::$app_name $version_type cannot be empty"
              exit 1
            fi
            
            # Stricter version validation: ^[v]?[0-9]+\.[0-9]+\.[0-9]+[a-z0-9]*$
            if [[ ! "$version" =~ ^[v]?[0-9]+\.[0-9]+\.[0-9]+[a-z0-9]*$ ]]; then
              echo "::error::$app_name $version_type must be a valid semantic version (e.g., '9.1.0', 'v6.2.2', '5.2b4'), got: $version"
              exit 1
            fi
          }
          
          # Parse new apps config
          echo "üìã Parsing new apps configuration..."
          if ! echo "$NEW_APPS_CONFIG" | jq empty 2>/dev/null; then
            echo "::error::Invalid JSON in new_apps_config"
            exit 1
          fi
          
          # Extract new apps from config
          declare -A NEW_APPS_IPA
          declare -A NEW_APPS_TWEAK
          declare -A NEW_APPS_TOGGLE
          
          for app_key in inshot appstorepp itorrent livecontainer reface; do
            if echo "$NEW_APPS_CONFIG" | jq -e ".${app_key}" >/dev/null 2>&1; then
              NEW_APPS_IPA["$app_key"]=$(echo "$NEW_APPS_CONFIG" | jq -r ".${app_key}.ipa")
              NEW_APPS_TWEAK["$app_key"]=$(echo "$NEW_APPS_CONFIG" | jq -r ".${app_key}.tweak")
              NEW_APPS_TOGGLE["$app_key"]=$(echo "$NEW_APPS_CONFIG" | jq -r ".${app_key}.update")
            else
              # Default values if not specified
              NEW_APPS_IPA["$app_key"]="0.0.0"
              NEW_APPS_TWEAK["$app_key"]="v0.0.0"
              NEW_APPS_TOGGLE["$app_key"]="false"
            fi
          done
          
          # Check if any app is enabled
          ANY_ENABLED=false
          
          # Check existing apps
          if [[ "$UPDATE_SPOTIFY" == "true" ]]; then
            ANY_ENABLED=true
            validate_version "$SPOTIFY_IPA_VERSION" "Spotify" "IPA version"
            validate_version "$SPOTIFY_TWEAK_VERSION" "Spotify" "Tweak version"
          fi
          
          if [[ "$UPDATE_YOUTUBE" == "true" ]]; then
            ANY_ENABLED=true
            validate_version "$YOUTUBE_IPA_VERSION" "YouTube" "IPA version"
            validate_version "$YOUTUBE_TWEAK_VERSION" "YouTube" "Tweak version"
          fi
          
          if [[ "$UPDATE_X" == "true" ]]; then
            ANY_ENABLED=true
            validate_version "$X_IPA_VERSION" "X" "IPA version"
            validate_version "$X_TWEAK_VERSION" "X" "Tweak version"
          fi
          
          # Check new apps
          for app_key in "${!NEW_APPS_TOGGLE[@]}"; do
            if [[ "${NEW_APPS_TOGGLE[$app_key]}" == "true" ]]; then
              ANY_ENABLED=true
              validate_version "${NEW_APPS_IPA[$app_key]}" "${app_key^}" "IPA version"
              validate_version "${NEW_APPS_TWEAK[$app_key]}" "${app_key^}" "Tweak version"
            fi
          done
          
          if [[ "$ANY_ENABLED" == "false" ]]; then
            echo "::notice::No apps enabled for update. Exiting."
            exit 0
          fi
          
          echo "‚úÖ Input validation complete"
          
          # Configure Git for PAT authentication
          echo "‚öôÔ∏è Configuring Git..."
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git remote set-url origin https://${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git
          echo "‚úÖ Git configured for PAT authentication"
          
          # Export new apps config for next step
          echo "NEW_APPS_IPA_JSON=$(jq -c . <<< '$(declare -p NEW_APPS_IPA | sed "s/declare -A NEW_APPS_IPA=//")')" >> $GITHUB_ENV
          echo "NEW_APPS_TWEAK_JSON=$(jq -c . <<< '$(declare -p NEW_APPS_TWEAK | sed "s/declare -A NEW_APPS_TWEAK=//")')" >> $GITHUB_ENV
          echo "NEW_APPS_TOGGLE_JSON=$(jq -c . <<< '$(declare -p NEW_APPS_TOGGLE | sed "s/declare -A NEW_APPS_TOGGLE=//")')" >> $GITHUB_ENV

      # STEP 3: Process all repository updates
      - name: "Process all repository updates"
        id: update-files
        env:
          # Existing apps
          SPOTIFY_IPA_VERSION: ${{ github.event.inputs.spotify_ipa_version }}
          SPOTIFY_TWEAK_VERSION: ${{ github.event.inputs.spotify_tweak_version }}
          UPDATE_SPOTIFY: ${{ github.event.inputs.update_spotify }}
          
          YOUTUBE_IPA_VERSION: ${{ github.event.inputs.youtube_ipa_version }}
          YOUTUBE_TWEAK_VERSION: ${{ github.event.inputs.youtube_tweak_version }}
          UPDATE_YOUTUBE: ${{ github.event.inputs.update_youtube }}
          
          X_IPA_VERSION: ${{ github.event.inputs.x_ipa_version }}
          X_TWEAK_VERSION: ${{ github.event.inputs.x_tweak_version }}
          UPDATE_X: ${{ github.event.inputs.update_x }}
          
          # Global
          UPDATE_WORKFLOW_DEFAULTS: ${{ github.event.inputs.update_workflow_defaults }}
        run: |
          set -e
          
          # Setup error handling and cleanup
          trap 'rm -f *.tmp *.bak' EXIT ERR
          
          # Get current date
          CURRENT_DATE=$(date -u +"%Y-%m-%d")
          echo "current_date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "üìÖ Processing date: $CURRENT_DATE"
          
          # Load new apps config from environment
          eval "declare -A NEW_APPS_IPA=${NEW_APPS_IPA_JSON}"
          eval "declare -A NEW_APPS_TWEAK=${NEW_APPS_TWEAK_JSON}"
          eval "declare -A NEW_APPS_TOGGLE=${NEW_APPS_TOGGLE_JSON}"
          
          # Define app configuration using associative arrays
          APP_KEYS=("spotify" "youtube" "x" "inshot" "appstorepp" "itorrent" "livecontainer" "reface")
          
          declare -A APP_NAMES=(
            ["spotify"]="EeveeSpotify"
            ["youtube"]="YTLite"
            ["x"]="X (NeoFreeBird)"
            ["inshot"]="InShot"
            ["appstorepp"]="AppStore++"
            ["itorrent"]="iTorrent"
            ["livecontainer"]="LiveContainer"
            ["reface"]="Reface"
          )
          
          declare -A APP_BUNDLES=(
            ["spotify"]="com.spotify.client"
            ["youtube"]="com.google.ios.youtube"
            ["x"]="com.atebits.Tweetie2"
            ["inshot"]="com.inshot.video"
            ["appstorepp"]="com.apple.AppStore"
            ["itorrent"]="ru.nonamelabs.iTorrent"
            ["livecontainer"]="com.kdt.livecontainer"
            ["reface"]="com.neocortext.reface"
          )
          
          declare -A APP_HTML_IDS=(
            ["spotify"]="eeveespotify"
            ["youtube"]="ytlite"
            ["x"]="neofreebird"
            ["inshot"]="inshot"
            ["appstorepp"]="appstorepp"
            ["itorrent"]="itorrent"
            ["livecontainer"]="livecontainer"
            ["reface"]="reface"
          )
          
          declare -A APP_URL_PATTERNS=(
            ["spotify"]="static:https://github.com/OofMini/eeveespotifyreborn/releases/download/New/EeveeSpotify.ipa"
            ["youtube"]="dynamic:https://github.com/OofMini/YTLite/releases/download/New/YouTubePlus_{version}.ipa"
            ["x"]="static:https://github.com/OofMini/tweak/releases/download/New/NeoFreeBird-sideloaded.ipa"
            ["inshot"]="dynamic:https://github.com/OofMini/InShot/releases/download/New/InShot_{version}.ipa"
            ["appstorepp"]="static:https://github.com/OofMini/AppStorePlusPlus/releases/download/New/AppStorePlusPlus.ipa"
            ["itorrent"]="dynamic:https://github.com/OofMini/iTorrent/releases/download/New/iTorrent_{version}.ipa"
            ["livecontainer"]="static:https://github.com/OofMini/LiveContainer/releases/download/New/LiveContainer.ipa"
            ["reface"]="dynamic:https://github.com/OofMini/Reface/releases/download/New/Reface_{version}.ipa"
          )
          
          declare -A APP_DESCRIPTIONS=(
            ["spotify"]="Tweaked Spotify with premium features unlocked, no ads, and enhanced playback. Spotify IPA %s, EeveeSpotify %s."
            ["youtube"]="Tweaked YouTube with background playback, no ads, and picture-in-picture. YouTube IPA %s, YTLite %s."
            ["x"]="Tweaked X with premium features and more. X IPA %s, NeoFreeBird %s."
            ["inshot"]="Tweaked InShot with pro features unlocked. InShot IPA %s, InShot Tweak %s."
            ["appstorepp"]="Tweaked App Store with app downgrading and enhanced features. App Store IPA %s, AppStore++ %s."
            ["itorrent"]="Feature-rich torrent client for iOS. iTorrent IPA %s, iTorrent %s."
            ["livecontainer"]="Run iOS apps in a containerized environment. LiveContainer IPA %s, LiveContainer %s."
            ["reface"]="Tweaked Reface with pro features unlocked. Reface IPA %s, Reface Tweak %s."
          )
          
          # Map environment variables to app configurations
          declare -A APP_TOGGLES=(
            ["spotify"]="$UPDATE_SPOTIFY"
            ["youtube"]="$UPDATE_YOUTUBE"
            ["x"]="$UPDATE_X"
          )
          
          # Add new apps from config
          for app_key in inshot appstorepp itorrent livecontainer reface; do
            APP_TOGGLES["$app_key"]="${NEW_APPS_TOGGLE[$app_key]}"
          done
          
          declare -A APP_IPA_VERSIONS=(
            ["spotify"]="$SPOTIFY_IPA_VERSION"
            ["youtube"]="$YOUTUBE_IPA_VERSION"
            ["x"]="$X_IPA_VERSION"
          )
          
          # Add new apps IPA versions
          for app_key in inshot appstorepp itorrent livecontainer reface; do
            APP_IPA_VERSIONS["$app_key"]="${NEW_APPS_IPA[$app_key]}"
          done
          
          declare -A APP_TWEAK_VERSIONS=(
            ["spotify"]="$SPOTIFY_TWEAK_VERSION"
            ["youtube"]="$YOUTUBE_TWEAK_VERSION"
            ["x"]="$X_TWEAK_VERSION"
          )
          
          # Add new apps tweak versions
          for app_key in inshot appstorepp itorrent livecontainer reface; do
            APP_TWEAK_VERSIONS["$app_key"]="${NEW_APPS_TWEAK[$app_key]}"
          done
          
          # Function to build download URL
          build_download_url() {
            local app_key="$1"
            local tweak_version="$2"
            local pattern="${APP_URL_PATTERNS[$app_key]}"
            
            if [[ "$pattern" == static:* ]]; then
              echo "${pattern#static:}"
            elif [[ "$pattern" == dynamic:* ]]; then
              local template="${pattern#dynamic:}"
              local version_clean="${tweak_version#v}"
              echo "${template//\{version\}/$version_clean}"
            fi
          }
          
          # Function to generate description
          generate_description() {
            local app_key="$1"
            local ipa_version="$2"
            local tweak_version="$3"
            local template="${APP_DESCRIPTIONS[$app_key]}"
            
            printf "$template" "$ipa_version" "$tweak_version"
          }
          
          # Function to update app in JSON file
          update_app_in_file() {
            local file="$1" 
            local app_name="$2" 
            local bundle_id="$3" 
            local ipa_version="$4" 
            local download_url="$5"
            local description="$6"
            local temp_file="${file}.tmp"
            
            # Check if app exists in file
            if ! jq -e --arg app "$app_name" --arg bundle "$bundle_id" \
                 '.apps[] | select(.name == $app or .bundleIdentifier == $bundle)' \
                 "$file" >/dev/null 2>&1; then
              echo "::warning::$app_name not found in $file, skipping..."
              return 0
            fi
            
            # Update based on file structure
            case "$file" in
              "sidestore.json")
                jq --arg app "$app_name" \
                   --arg bundle "$bundle_id" \
                   --arg version "$ipa_version" \
                   --arg url "$download_url" \
                   --arg desc "$description" \
                   --arg date "$CURRENT_DATE" \
                   '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                    (.versions[0].version = $version | 
                     .versions[0].downloadURL = $url | 
                     .versions[0].date = $date | 
                     .localizedDescription = $desc)' "$file" > "$temp_file"
                ;;
              "feather.json")
                jq --arg app "$app_name" \
                   --arg bundle "$bundle_id" \
                   --arg version "$ipa_version" \
                   --arg url "$download_url" \
                   --arg desc "$description" \
                   --arg date "$CURRENT_DATE" \
                   '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                    (.version = $version | 
                     .downloadURL = $url | 
                     .versionDate = $date |
                     .versions[0].version = $version | 
                     .versions[0].downloadURL = $url | 
                     .versions[0].date = $date | 
                     .localizedDescription = $desc)' "$file" > "$temp_file"
                ;;
              "trollapps.json")
                jq --arg app "$app_name" \
                   --arg bundle "$bundle_id" \
                   --arg version "$ipa_version" \
                   --arg url "$download_url" \
                   --arg desc "$description" \
                   '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                    (.version = $version | 
                     .downloadURL = $url | 
                     .localizedDescription = $desc)' "$file" > "$temp_file"
                ;;
            esac
            
            # Validate and move
            if ! jq empty "$temp_file" 2>/dev/null; then
              echo "::error::Generated invalid JSON for $file"
              rm -f "$temp_file"
              return 1
            fi
            
            if cmp -s "$file" "$temp_file"; then
              rm -f "$temp_file"
            else
              mv "$temp_file" "$file"
              echo "‚úÖ Updated $app_name in $file"
            fi
          }
          
          # Function to update HTML file
          update_html_file() {
            local html_id="$1"
            local app_name="$2"
            local ipa_version="$3"
            local tweak_version="$4"
            
            if [ ! -f "index.html" ]; then
              echo "::warning::index.html not found"
              return 0
            fi
            
            # Clean app name for regex (escape special characters)
            local clean_app_name=$(echo "$app_name" | sed 's/[()]/\\&/g')
            
            # Combine sed operations for efficiency
            sed -i \
              -e "/id: '${html_id}'/,/^[[:space:]]*},/{ s/\(version: '\)[0-9][0-9.]*\(',\)/\1$ipa_version\2/ }" \
              -e "/id: '${html_id}'/,/^[[:space:]]*},/{ s/\(${clean_app_name} IPA \)[0-9][0-9.]*\(, .* \)v\{0,1\}[0-9a-z.]*/\1$ipa_version\2$tweak_version/ }" \
              "index.html"
          }
          
          # Function to update workflow defaults
          update_workflow_defaults() {
            local app_key="$1"
            local ipa_version="$2"
            local tweak_version="$3"
            local workflow_file=".github/workflows/update-repos.yml"
            
            if [ ! -f "$workflow_file" ]; then
              echo "::warning::Workflow file not found"
              return 0
            fi
            
            # Update both IPA and tweak version defaults
            sed -i \
              -e "/${app_key}_ipa_version:/,/default:/ s/\(default: \)\"[^\"]*\"/\1\"$ipa_version\"/" \
              -e "/${app_key}_tweak_version:/,/default:/ s/\(default: \)\"[^\"]*\"/\1\"$tweak_version\"/" \
              "$workflow_file"
          }
          
          # Validate JSON files exist and are valid
          echo "üìÑ Validating JSON files..."
          JSON_FILES=("sidestore.json" "feather.json" "trollapps.json")
          for file in "${JSON_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "::error::$file not found"
              exit 1
            fi
            
            if ! jq empty "$file" 2>/dev/null; then
              echo "::error::$file - Invalid JSON"
              exit 1
            fi
            
            if ! jq -e '.apps | type == "array"' "$file" >/dev/null 2>&1; then
              echo "::error::$file - Missing or invalid apps array"
              exit 1
            fi
            
            echo "‚úÖ $file - Valid JSON"
          done
          
          # Initialize tracking arrays
          UPDATED_APPS=()
          UPDATED_VERSIONS=()
          SKIPPED_APPS=()
          
          # Process each app
          for app_key in "${APP_KEYS[@]}"; do
            # Get toggle value
            toggle_value="${APP_TOGGLES[$app_key]}"
            
            # Check if app is enabled
            if [[ "$toggle_value" != "true" ]]; then
              echo "::notice::Skipping ${APP_NAMES[$app_key]} (toggle disabled)"
              SKIPPED_APPS+=("${APP_NAMES[$app_key]}")
              continue
            fi
            
            # Get versions
            IPA_VERSION="${APP_IPA_VERSIONS[$app_key]}"
            TWEAK_VERSION="${APP_TWEAK_VERSIONS[$app_key]}"
            
            # Get app metadata
            APP_NAME="${APP_NAMES[$app_key]}"
            BUNDLE_ID="${APP_BUNDLES[$app_key]}"
            HTML_ID="${APP_HTML_IDS[$app_key]}"
            DOWNLOAD_URL=$(build_download_url "$app_key" "$TWEAK_VERSION")
            DESCRIPTION=$(generate_description "$app_key" "$IPA_VERSION" "$TWEAK_VERSION")
            
            echo ""
            echo "========================================"
            echo "üîÑ Processing $APP_NAME..."
            echo "========================================"
            echo "üì¶ IPA Version: $IPA_VERSION"
            echo "‚öôÔ∏è Tweak Version: $TWEAK_VERSION"
            echo "üîó Download URL: $DOWNLOAD_URL"
            
            # Update JSON files
            for json_file in "${JSON_FILES[@]}"; do
              update_app_in_file "$json_file" "$APP_NAME" "$BUNDLE_ID" "$IPA_VERSION" "$DOWNLOAD_URL" "$DESCRIPTION"
            done
            
            # Update HTML (index.html)
            if [ -f "index.html" ]; then
              echo "üåê Updating HTML for $APP_NAME..."
              update_html_file "$HTML_ID" "$APP_NAME" "$IPA_VERSION" "$TWEAK_VERSION"
            fi
            
            # Update workflow defaults (if enabled globally)
            if [[ "$UPDATE_WORKFLOW_DEFAULTS" == "true" ]]; then
              echo "‚öôÔ∏è Updating workflow defaults for $APP_NAME..."
              update_workflow_defaults "$app_key" "$IPA_VERSION" "$TWEAK_VERSION"
            fi
            
            # Track update
            UPDATED_APPS+=("$APP_NAME")
            UPDATED_VERSIONS+=("${app_key}:${IPA_VERSION}:${TWEAK_VERSION}")
            
            echo "‚úÖ $APP_NAME processing complete"
          done
          
          # Set outputs
          if [ ${#UPDATED_APPS[@]} -gt 0 ]; then
            echo "updated_apps=${UPDATED_APPS[*]}" >> $GITHUB_OUTPUT
            echo "updated_versions=${UPDATED_VERSIONS[*]}" >> $GITHUB_OUTPUT
          fi
          
          if [ ${#SKIPPED_APPS[@]} -gt 0 ]; then
            echo "skipped_apps=${SKIPPED_APPS[*]}" >> $GITHUB_OUTPUT
          fi
          
          # Final validation of all JSON files
          echo ""
          echo "üîç Final validation..."
          for file in "${JSON_FILES[@]}"; do
            if ! jq empty "$file" 2>/dev/null; then
              echo "::error::Final validation failed for $file"
              exit 1
            fi
            echo "‚úÖ $file validated"
          done
          
          echo ""
          echo "========================================"
          if [ ${#UPDATED_APPS[@]} -gt 0 ]; then
            echo "‚úÖ Successfully processed: ${UPDATED_APPS[*]}"
          else
            echo "::warning::No apps were updated"
          fi
          echo "========================================"

      # STEP 4: Commit and push changes
      - name: "Commit and push changes"
        if: steps.update-files.outputs.updated_apps
        run: |
          set -e
          
          # Build commit message
          if [[ -n "${{ github.event.inputs.change_description }}" ]]; then
            COMMIT_MSG="${{ github.event.inputs.change_description }}"
          else
            COMMIT_MSG="Repository Sync: Updated app versions across all sources"
            
            # Add updated apps section
            UPDATED_APPS_STR="${{ steps.update-files.outputs.updated_apps }}"
            if [ -n "$UPDATED_APPS_STR" ]; then
              IFS=' ' read -ra UPDATED_APPS_ARR <<< "$UPDATED_APPS_STR"
              COMMIT_MSG="$COMMIT_MSG"$'\n\n'"Updated apps:"
              for app in "${UPDATED_APPS_ARR[@]}"; do
                COMMIT_MSG="$COMMIT_MSG"$'\n'"- $app"
              done
            fi
            
            # Add skipped apps section
            SKIPPED_APPS_STR="${{ steps.update-files.outputs.skipped_apps }}"
            if [ -n "$SKIPPED_APPS_STR" ]; then
              IFS=' ' read -ra SKIPPED_APPS_ARR <<< "$SKIPPED_APPS_STR"
              COMMIT_MSG="$COMMIT_MSG"$'\n\n'"Skipped apps (toggle disabled):"
              for app in "${SKIPPED_APPS_ARR[@]}"; do
                COMMIT_MSG="$COMMIT_MSG"$'\n'"- $app"
              done
            fi
            
            # Add version details section
            UPDATED_VERSIONS_STR="${{ steps.update-files.outputs.updated_versions }}"
            if [ -n "$UPDATED_VERSIONS_STR" ]; then
              COMMIT_MSG="$COMMIT_MSG"$'\n\n'"Version details:"
              IFS=' ' read -ra VERSION_PAIRS <<< "$UPDATED_VERSIONS_STR"
              for version_pair in "${VERSION_PAIRS[@]}"; do
                IFS=':' read -ra PARTS <<< "$version_pair"
                APP_KEY="${PARTS[0]}"
                IPA_VER="${PARTS[1]}"
                TWEAK_VER="${PARTS[2]}"
                # Capitalize first letter of app key for display
                APP_DISPLAY="${APP_KEY^}"
                COMMIT_MSG="$COMMIT_MSG"$'\n'"- ${APP_DISPLAY}: IPA $IPA_VER, Tweak $TWEAK_VER"
              done
            fi
            
            # Add note about workflow defaults update
            if [[ "${{ github.event.inputs.update_workflow_defaults }}" == "true" ]]; then
              COMMIT_MSG="$COMMIT_MSG"$'\n\n'"Updated workflow default versions"
            fi
            
            COMMIT_MSG="$COMMIT_MSG"$'\n\n'"Automated update via GitHub Actions"
          fi
          
          # Stage changed files
          git add sidestore.json feather.json trollapps.json
          
          # Add index.html only if it was modified
          if [ -f index.html ] && ! git diff --quiet index.html 2>/dev/null; then
            git add index.html
          fi
          
          # Add workflow file if it was modified
          WORKFLOW_FILE=".github/workflows/update-repos.yml"
          if [ -f "$WORKFLOW_FILE" ] && ! git diff --quiet "$WORKFLOW_FILE" 2>/dev/null; then
            git add "$WORKFLOW_FILE"
            echo "‚öôÔ∏è Workflow file changes staged"
          fi
          
          # Check if there are staged changes
          if git diff --staged --quiet; then
            echo "::notice::No changes to commit - files are already up to date"
            echo "no_changes=true" >> $GITHUB_OUTPUT
          else
            # Commit changes
            git commit -m "$COMMIT_MSG"
            
            # Push with retry logic using PAT authentication
            echo "üöÄ Pushing changes to repository using PAT..."
            MAX_RETRIES=3
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if git push origin HEAD; then
                echo "‚úÖ Changes committed and pushed successfully using PAT"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "::warning::Push failed, pulling and retrying... (Attempt $RETRY_COUNT/$MAX_RETRIES)"
                  git pull --rebase origin HEAD
                else
                  echo "::error::Failed to push after $MAX_RETRIES attempts"
                  exit 1
                fi
              fi
            done
          fi

      # STEP 5: Generate summary (always runs)
      - name: "Generate summary"
        if: always()
        run: |
          {
            echo "## üì¶ Repository Update Summary"
            echo ""
            
            # Job status
            if [ "${{ job.status }}" == "success" ]; then
              echo "‚úÖ **Status**: Success"
            else
              echo "‚ùå **Status**: Failed"
            fi
            echo ""
            
            # Apps updated
            echo "### üì± Apps Updated:"
            UPDATED_APPS_STR="${{ steps.update-files.outputs.updated_apps }}"
            if [ -n "$UPDATED_APPS_STR" ]; then
              IFS=' ' read -ra UPDATED_APPS_ARR <<< "$UPDATED_APPS_STR"
              for app in "${UPDATED_APPS_ARR[@]}"; do
                echo "- ‚úì $app"
              done
              echo ""
              echo "**Processed ${#UPDATED_APPS_ARR[@]} of 8 apps**"
            else
              echo "- ‚ÑπÔ∏è No apps were updated"
              echo ""
              echo "**Processed 0 of 8 apps**"
            fi
            
            # Apps skipped
            echo ""
            echo "### üö´ Apps Skipped (Toggle Disabled):"
            SKIPPED_APPS_STR="${{ steps.update-files.outputs.skipped_apps }}"
            if [ -n "$SKIPPED_APPS_STR" ]; then
              IFS=' ' read -ra SKIPPED_APPS_ARR <<< "$SKIPPED_APPS_STR"
              for app in "${SKIPPED_APPS_ARR[@]}"; do
                echo "- $app"
              done
            else
              echo "- ‚ÑπÔ∏è No apps were skipped"
            fi
            
            echo ""
            echo "### üî¢ Version Details:"
            UPDATED_VERSIONS_STR="${{ steps.update-files.outputs.updated_versions }}"
            if [ -n "$UPDATED_VERSIONS_STR" ]; then
              IFS=' ' read -ra VERSION_PAIRS <<< "$UPDATED_VERSIONS_STR"
              for version_pair in "${VERSION_PAIRS[@]}"; do
                IFS=':' read -ra PARTS <<< "$version_pair"
                APP_KEY="${PARTS[0]}"
                IPA_VER="${PARTS[1]}"
                TWEAK_VER="${PARTS[2]}"
                APP_DISPLAY="${APP_KEY^}"
                echo "- **${APP_DISPLAY}**:"
                echo "  - IPA Version: \`$IPA_VER\`"
                echo "  - Tweak Version: \`$TWEAK_VER\`"
              done
            else
              echo "- ‚ÑπÔ∏è No version updates"
            fi
            
            echo ""
            echo "### üìÑ Files Processed:"
            echo "- \`sidestore.json\`"
            echo "- \`feather.json\`"
            echo "- \`trollapps.json\`"
            if [ -f "index.html" ]; then
              echo "- \`index.html\`"
            fi
            if [[ "${{ github.event.inputs.update_workflow_defaults }}" == "true" ]]; then
              echo "- \`.github/workflows/update-repos.yml\` (workflow defaults)"
            fi
            
            echo ""
            echo "### ‚öôÔ∏è Configuration:"
            echo "- Update workflow defaults: \`${{ github.event.inputs.update_workflow_defaults }}\`"
            echo "- Authentication: PAT Token"
            
            echo ""
            echo "### ‚è∞ Execution Time:"
            echo "- Date: \`${{ steps.update-files.outputs.current_date }}\`"
            echo "- Workflow: [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            
            echo ""
            echo "---"
            echo "*Automated repository management via GitHub Actions*"
          } >> $GITHUB_STEP_SUMMARY 2>&1 || echo "::warning::Failed to write step summary"