name: Bulk IPA Updates

on:
  workflow_dispatch:
    inputs:
      update_spotify:
        description: "Update Spotify"
        type: boolean
        default: false
      spotify_ipa_version:
        description: "Spotify IPA Version:"
        default: "9.0.91"
      spotify_tweak_version:
        description: "Spotify Tweak Version:"
        default: "v6.2"
      
      update_youtube:
        description: "Update YouTube"
        type: boolean
        default: false
      youtube_ipa_version:
        description: "YouTube IPA Version:"
        default: "20.44.2"
      youtube_tweak_version:
        description: "YouTube Tweak Version:"
        default: "v5.2b4"
      
      update_x:
        description: "Update X"
        type: boolean
        default: false
      x_ipa_version:
        description: "X IPA Version:"
        default: "11.36"
      x_tweak_version:
        description: "X Tweak Version:"
        default: "v5.2"
      
      change_description:
        description: "Custom commit message (optional)"
        default: ""

jobs:
  repository-sync:
    name: "Sync App Repository"
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout repository"
        uses: OofMini/checkout@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Install dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: "Update repository files"
        id: update-files
        run: |
          set -e
          CURRENT_DATE=$(date -u +"%Y-%m-%d")
          echo "current_date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          
          # Function to build download URL from tweak version (without 'v' prefix)
          build_download_info() {
            local app_name="$1"
            local tweak_version="$2"
            
            case "$app_name" in
              "EeveeSpotify")
                echo "https://github.com/OofMini/eeveespotifyreborn/releases/download/New/EeveeSpotify.ipa"
                ;;
              "YTLite")
                # Remove 'v' prefix from tweak version for filename
                local clean_tweak_version="${tweak_version#v}"
                echo "https://github.com/OofMini/YTLite/releases/download/New/YouTubePlus_${clean_tweak_version}.ipa"
                ;;
              "X (NeoFreeBird)")
                echo "https://github.com/OofMini/tweak/releases/download/New/NeoFreeBird-sideloaded.ipa"
                ;;
              *)
                echo "Unknown app: $app_name"
                exit 1
                ;;
            esac
          }
          
          # Function to validate JSON syntax
          validate_json() {
            echo "Validating JSON file structure..."
            for file in sidestore.json feather.json trollapps.json; do
              if [ -f "$file" ]; then
                if jq empty "$file" 2>/dev/null; then
                  echo "$file - Valid JSON syntax"
                else
                  echo "$file - Invalid JSON syntax"
                  exit 1
                fi
              else
                echo "$file - File not found"
                exit 1
              fi
            done
          }
          
          # Function to validate JSON structure requirements
          validate_json_structure() {
            echo "Validating JSON structure requirements..."
            
            for file in sidestore.json feather.json trollapps.json; do
              if [ -f "$file" ]; then
                echo "Checking structure of $file..."
                
                # Check if file has required 'apps' array
                if ! jq -e '.apps | type == "array"' "$file" > /dev/null; then
                  echo "$file - Missing required 'apps' array"
                  exit 1
                fi
                
                # Check if apps array is not empty
                APP_COUNT=$(jq '.apps | length' "$file")
                if [ "$APP_COUNT" -eq 0 ]; then
                  echo "$file - 'apps' array is empty"
                else
                  echo "$file - Valid structure with $APP_COUNT apps"
                fi
              fi
            done
            echo "All JSON files have valid structure"
          }
          
          # Function to update app in JSON file
          update_app_in_file() {
            local file="$1"
            local app_name="$2"
            local bundle_id="$3"
            local ipa_version="$4"
            local tweak_version="$5"
            
            echo "Updating $app_name in $file..."
            
            # Build the complete download URL (without 'v' prefix for YouTube)
            local download_url
            download_url=$(build_download_info "$app_name" "$tweak_version")
            echo "Download URL: $download_url"
            
            # Generate localized description with updated versions
            local LOCALIZED_DESC
            if [[ "$app_name" == "EeveeSpotify" ]]; then
              LOCALIZED_DESC="Tweaked Spotify with premium features unlocked, no ads, and enhanced playback. Spotify IPA $ipa_version, EeveeSpotify $tweak_version."
            elif [[ "$app_name" == "YTLite" ]]; then
              LOCALIZED_DESC="Tweaked YouTube with background playback, no ads, and picture-in-picture. YouTube IPA $ipa_version, YTLite $tweak_version."
            elif [[ "$app_name" == "X (NeoFreeBird)" ]]; then
              LOCALIZED_DESC="Tweaked X with premium features and more. X IPA $ipa_version, NeoFreeBird $tweak_version."
            else
              # Fallback to existing description if app not recognized
              LOCALIZED_DESC=$(jq -r --arg app "$app_name" --arg bundle "$bundle_id" '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)).localizedDescription // "Tweaked application with enhanced features."' "$file")
            fi
            
            # Create temporary file for processing
            local temp_file="${file}.tmp"
            
            # Update based on file structure
            if [[ "$file" == "sidestore.json" ]]; then
              jq --arg app "$app_name" \
                 --arg bundle "$bundle_id" \
                 --arg version "$ipa_version" \
                 --arg url "$download_url" \
                 --arg desc "$LOCALIZED_DESC" \
                 --arg date "$CURRENT_DATE" \
                 '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                  (.versions[0].version = $version |
                   .versions[0].downloadURL = $url |
                   .versions[0].date = $date |
                   .localizedDescription = $desc)' "$file" > "$temp_file"
                  
            elif [[ "$file" == "feather.json" ]]; then
              jq --arg app "$app_name" \
                 --arg bundle "$bundle_id" \
                 --arg version "$ipa_version" \
                 --arg url "$download_url" \
                 --arg desc "$LOCALIZED_DESC" \
                 --arg date "$CURRENT_DATE" \
                 '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                  (.version = $version |
                   .downloadURL = $url |
                   .versionDate = $date |
                   .size = (if .versions[0].size then .versions[0].size else 0 end) |
                   .versions[0].version = $version |
                   .versions[0].downloadURL = $url |
                   .versions[0].date = $date |
                   .localizedDescription = $desc)' "$file" > "$temp_file"
                  
            else  # trollapps.json
              jq --arg app "$app_name" \
                 --arg bundle "$bundle_id" \
                 --arg version "$ipa_version" \
                 --arg url "$download_url" \
                 --arg desc "$LOCALIZED_DESC" \
                 '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                  (.version = $version |
                   .downloadURL = $url |
                   .localizedDescription = $desc)' "$file" > "$temp_file"
            fi
            
            # Verify the temp file was created successfully
            if [ -f "$temp_file" ] && jq empty "$temp_file" 2>/dev/null; then
              mv "$temp_file" "$file"
              echo "Successfully updated $app_name in $file"
            else
              echo "Failed to update $app_name in $file - temp file invalid"
              rm -f "$temp_file"
              exit 1
            fi
          }

          # Validate files first
          validate_json
          validate_json_structure
          
          # Initialize updated apps array and store versions for workflow update
          UPDATED_APPS=()
          UPDATED_VERSIONS=()
          
          # Update apps based on individual toggles
          if [[ "${{ github.event.inputs.update_spotify }}" == "true" ]]; then
            echo "Processing Spotify update..."
            echo "Spotify IPA Version: ${{ github.event.inputs.spotify_ipa_version }}, Tweak Version: ${{ github.event.inputs.spotify_tweak_version }}"
            
            UPDATED_APPS+=("EeveeSpotify")
            UPDATED_VERSIONS+=("spotify:${{ github.event.inputs.spotify_ipa_version }}:${{ github.event.inputs.spotify_tweak_version }}")
            
            for file in sidestore.json feather.json trollapps.json; do
              update_app_in_file "$file" "EeveeSpotify" "com.spotify.client" \
                "${{ github.event.inputs.spotify_ipa_version }}" \
                "${{ github.event.inputs.spotify_tweak_version }}"
            done
          fi

          if [[ "${{ github.event.inputs.update_youtube }}" == "true" ]]; then
            echo "Processing YouTube update..."
            echo "YouTube IPA Version: ${{ github.event.inputs.youtube_ipa_version }}, Tweak Version: ${{ github.event.inputs.youtube_tweak_version }}"
            
            UPDATED_APPS+=("YTLite")
            UPDATED_VERSIONS+=("youtube:${{ github.event.inputs.youtube_ipa_version }}:${{ github.event.inputs.youtube_tweak_version }}")
            
            for file in sidestore.json feather.json trollapps.json; do
              update_app_in_file "$file" "YTLite" "com.google.ios.youtube" \
                "${{ github.event.inputs.youtube_ipa_version }}" \
                "${{ github.event.inputs.youtube_tweak_version }}"
            done
          fi

          if [[ "${{ github.event.inputs.update_x }}" == "true" ]]; then
            echo "Processing X update..."
            echo "X IPA Version: ${{ github.event.inputs.x_ipa_version }}, Tweak Version: ${{ github.event.inputs.x_tweak_version }}"
            
            UPDATED_APPS+=("X (NeoFreeBird)")
            UPDATED_VERSIONS+=("x:${{ github.event.inputs.x_ipa_version }}:${{ github.event.inputs.x_tweak_version }}")
            
            for file in sidestore.json feather.json trollapps.json; do
              update_app_in_file "$file" "X (NeoFreeBird)" "com.atebits.Tweetie2" \
                "${{ github.event.inputs.x_ipa_version }}" \
                "${{ github.event.inputs.x_tweak_version }}"
            done
          fi

          # Output updated apps for subsequent steps
          if [ ${#UPDATED_APPS[@]} -gt 0 ]; then
            APPS_STR=$(printf "%s " "${UPDATED_APPS[@]}")
            VERSIONS_STR=$(printf "%s " "${UPDATED_VERSIONS[@]}")
            echo "updated_apps=${APPS_STR% }" >> $GITHUB_OUTPUT
            echo "updated_versions=${VERSIONS_STR% }" >> $GITHUB_OUTPUT
            echo "Apps to be updated: ${UPDATED_APPS[*]}"
          else
            echo "No apps selected for update"
          fi
          
          # Verify changes after updates
          echo "Verifying updated files..."
          for file in sidestore.json feather.json trollapps.json; do
            if jq empty "$file" 2>/dev/null; then
              echo "$file - Valid JSON after updates"
            else
              echo "$file - Invalid JSON after updates"
              exit 1
            fi
          done

      - name: "Update index.html with new versions"
        if: steps.update-files.outputs.updated_versions
        run: |
          echo "Updating index.html with new app versions..."
          
          # Get the updated versions from previous step
          UPDATED_VERSIONS_STR="${{ steps.update-files.outputs.updated_versions }}"
          IFS=' ' read -ra VERSION_PAIRS <<< "$UPDATED_VERSIONS_STR"
          
          # Read current index.html
          if [ -f "index.html" ]; then
            # Create a temporary copy
            cp "index.html" "index.html.tmp"
            
            # Update each app's version in index.html using simple sed commands
            for version_pair in "${VERSION_PAIRS[@]}"; do
              IFS=':' read -ra PARTS <<< "$version_pair"
              APP="${PARTS[0]}"
              IPA_VERSION="${PARTS[1]}"
              TWEAK_VERSION="${PARTS[2]}"
              
              echo "Updating $APP in index.html to IPA: $IPA_VERSION, Tweak: $TWEAK_VERSION"
              
              case "$APP" in
                "spotify")
                  # Update Spotify version and description
                  sed -i "s/version: '[0-9][0-9.]*',/version: '$IPA_VERSION',/" "index.html.tmp"
                  sed -i "s|Spotify IPA [0-9][0-9.]*, EeveeSpotify v[0-9a-z.]*|Spotify IPA $IPA_VERSION, EeveeSpotify $TWEAK_VERSION|" "index.html.tmp"
                  ;;
                "youtube")
                  # Update YouTube version and description
                  sed -i "s/version: '[0-9][0-9.]*',/version: '$IPA_VERSION',/" "index.html.tmp"
                  sed -i "s|YouTube IPA [0-9][0-9.]*, YTLite v[0-9a-z.]*|YouTube IPA $IPA_VERSION, YTLite $TWEAK_VERSION|" "index.html.tmp"
                  ;;
                "x")
                  # Update X version and description
                  sed -i "s/version: '[0-9][0-9.]*',/version: '$IPA_VERSION',/" "index.html.tmp"
                  sed -i "s|X IPA [0-9][0-9.]*, NeoFreeBird v[0-9a-z.]*|X IPA $IPA_VERSION, NeoFreeBird $TWEAK_VERSION|" "index.html.tmp"
                  ;;
              esac
            done
            
            # Replace the original file
            mv "index.html.tmp" "index.html"
            echo "index.html updated with new app versions"
          else
            echo "Warning: Could not find index.html to update"
          fi

      - name: "Update workflow with new versions"
        if: steps.update-files.outputs.updated_versions
        run: |
          echo "Updating workflow with new version defaults..."
          
          # Get the updated versions from previous step
          UPDATED_VERSIONS_STR="${{ steps.update-files.outputs.updated_versions }}"
          IFS=' ' read -ra VERSION_PAIRS <<< "$UPDATED_VERSIONS_STR"
          
          # Read current workflow file
          WORKFLOW_FILE=".github/workflows/main.yml"
          if [ ! -f "$WORKFLOW_FILE" ]; then
            WORKFLOW_FILE=".github/workflows/${{ github.workflow }}.yml"
          fi
          
          if [ -f "$WORKFLOW_FILE" ]; then
            # Create a temporary copy
            cp "$WORKFLOW_FILE" "${WORKFLOW_FILE}.tmp"
            
            # Update each app's default versions
            for version_pair in "${VERSION_PAIRS[@]}"; do
              IFS=':' read -ra PARTS <<< "$version_pair"
              APP="${PARTS[0]}"
              IPA_VERSION="${PARTS[1]}"
              TWEAK_VERSION="${PARTS[2]}"
              
              echo "Updating $APP defaults to IPA: $IPA_VERSION, Tweak: $TWEAK_VERSION"
              
              # Update IPA version default - match the exact format
              sed -i "s|^      ${APP}_ipa_version:.*|      ${APP}_ipa_version:\n        description: \"${APP^} IPA Version:\"\n        default: \"$IPA_VERSION\"|" "${WORKFLOW_FILE}.tmp"
              
              # Update tweak version default - match the exact format
              sed -i "s|^      ${APP}_tweak_version:.*|      ${APP}_tweak_version:\n        description: \"${APP^} Tweak Version:\"\n        default: \"$TWEAK_VERSION\"|" "${WORKFLOW_FILE}.tmp"
            done
            
            # Replace the original file
            mv "${WORKFLOW_FILE}.tmp" "$WORKFLOW_FILE"
            echo "Workflow file updated with new version defaults"
          else
            echo "Warning: Could not find workflow file to update defaults"
          fi

      - name: "Commit and push changes"
        if: steps.update-files.outputs.updated_apps
        run: |
          # Generate commit message
          if [[ -n "${{ github.event.inputs.change_description }}" ]]; then
            COMMIT_MSG="${{ github.event.inputs.change_description }}"
          else
            COMMIT_MSG="Repository Sync: Updated app versions across all sources"
            
            # Get updated apps from previous step
            UPDATED_APPS_STR="${{ steps.update-files.outputs.updated_apps }}"
            IFS=' ' read -ra UPDATED_APPS_ARR <<< "$UPDATED_APPS_STR"
            
            if [ ${#UPDATED_APPS_ARR[@]} -gt 0 ]; then
              COMMIT_MSG+="\n\nUpdated apps:"
              for app in "${UPDATED_APPS_ARR[@]}"; do
                COMMIT_MSG+="\nâ€¢ $app"
              done
            fi
            
            COMMIT_MSG+="\n\nAutomated update via GitHub Actions"
          fi
          
          # Configure git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add changed files (JSON files, index.html, and potentially the workflow file)
          git add sidestore.json feather.json trollapps.json index.html
          if [[ -f ".github/workflows/main.yml" ]]; then
            git add ".github/workflows/main.yml"
          elif [[ -f ".github/workflows/${{ github.workflow }}.yml" ]]; then
            git add ".github/workflows/${{ github.workflow }}.yml"
          fi
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit - files are already up to date"
          else
            git commit -m "$(echo -e "$COMMIT_MSG")"
            git push
            echo "Changes committed and pushed successfully"
          fi

      - name: "Update summary"
        run: |
          echo "## Repository Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Apps Updated:" >> $GITHUB_STEP_SUMMARY
          
          UPDATED_APPS_STR="${{ steps.update-files.outputs.updated_apps }}"
          if [ -n "$UPDATED_APPS_STR" ]; then
            IFS=' ' read -ra UPDATED_APPS_ARR <<< "$UPDATED_APPS_STR"
            for app in "${UPDATED_APPS_ARR[@]}"; do
              echo "- $app" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "No apps were updated (all toggles were off or no changes detected)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Updated:" >> $GITHUB_STEP_SUMMARY
          echo "- sidestore.json" >> $GITHUB_STEP_SUMMARY
          echo "- feather.json" >> $GITHUB_STEP_SUMMARY  
          echo "- trollapps.json" >> $GITHUB_STEP_SUMMARY
          echo "- index.html" >> $GITHUB_STEP_SUMMARY
          
          # Check if workflow was updated
          if [[ "${{ steps.update-files.outputs.updated_versions }}" ]]; then
            echo "- workflow.yml (updated defaults)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### New Default Versions Set:" >> $GITHUB_STEP_SUMMARY
            UPDATED_VERSIONS_STR="${{ steps.update-files.outputs.updated_versions }}"
            IFS=' ' read -ra VERSION_PAIRS <<< "$UPDATED_VERSIONS_STR"
            for version_pair in "${VERSION_PAIRS[@]}"; do
              IFS=':' read -ra PARTS <<< "$version_pair"
              APP="${PARTS[0]}"
              IPA_VERSION="${PARTS[1]}"
              TWEAK_VERSION="${PARTS[2]}"
              echo "- ${APP^}: IPA $IPA_VERSION, Tweak $TWEAK_VERSION" >> $GITHUB_STEP_SUMMARY
            done
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "Automated repository management" >> $GITHUB_STEP_SUMMARY