name: ðŸš€ Repository Manager - Bulk App Updates

on:
  workflow_dispatch:
    inputs:
      # Spotify
      spotify_header:
        description: "ðŸŽµ Spotify"
        required: false
      update_eeveespotify:
        description: "Update EeveeSpotify"
        type: boolean
        default: false
      eeveespotify_version:
        description: "EeveeSpotify Version"
        default: "9.0.91"
      eeveespotify_tweak_version:
        description: "EeveeSpotify Tweak Version"
        default: "v6.2"
      eeveespotify_download_url:
        description: "EeveeSpotify Download URL"
        default: "https://github.com/OofMini/eeveespotifyreborn/releases/download/New/EeveeSpotify.ipa"

      # YouTube
      youtube_header:
        description: "ðŸ“º YouTube"
        required: false
      update_ytlite:
        description: "Update YTLite"
        type: boolean
        default: false
      ytlite_version:
        description: "YTLite Version"
        default: "20.44.2"
      ytlite_tweak_version:
        description: "YTLite Tweak Version"
        default: "v5.2b4"
      ytlite_download_url:
        description: "YTLite Download URL"
        default: "https://github.com/OofMini/YTLite/releases/download/New/YouTubePlus_5.2b4.ipa"

      # Twitter/X
      twitter_header:
        description: "ðŸ¦ Twitter/X"
        required: false
      update_x_neofreebird:
        description: "Update X (NeoFreeBird)"
        type: boolean
        default: false
      x_neofreebird_version:
        description: "X Version"
        default: "11.36"
      x_neofreebird_tweak_version:
        description: "X Tweak Version"
        default: "v5.2"
      x_neofreebird_download_url:
        description: "X Download URL"
        default: "https://github.com/OofMini/tweak/releases/download/New/NeoFreeBird-sideloaded.ipa"

      # InshotPro
      inshot_header:
        description: "ðŸŽ¬ InshotPro"
        required: false
      update_inshotpro:
        description: "Update InshotPro"
        type: boolean
        default: false
      inshotpro_version:
        description: "InshotPro Version"
        default: "1.90.2"
      inshotpro_download_url:
        description: "InshotPro Download URL"
        default: "https://www.dropbox.com/scl/fi/z9pg3t8e5rkauyh51duud/InShot-ipaomtk.com.ipa?rlkey=whj0y0ex86tondgcdn9t7dxnv&st=nzcaijfi&dl=1"

      # RefacePro
      reface_header:
        description: "ðŸ¤– RefacePro"
        required: false
      update_refacepro:
        description: "Update RefacePro"
        type: boolean
        default: false
      refacepro_version:
        description: "RefacePro Version"
        default: "5.23.0"
      refacepro_download_url:
        description: "RefacePro Download URL"
        default: "https://www.dropbox.com/scl/fi/kaffbspyr1672l2okzpv5/Reface.ipa?rlkey=fp1f4xhxl0j439s9ub0pkvrtt&st=iu6ldqpw&dl=1"

      # Amethyst
      amethyst_header:
        description: "âš¡ Amethyst"
        required: false
      update_amethyst:
        description: "Update Amethyst"
        type: boolean
        default: false
      amethyst_version:
        description: "Amethyst Version"
        default: "1.0"
      amethyst_download_url:
        description: "Amethyst Download URL"
        default: "https://www.dropbox.com/scl/fi/j2pk7iaiodrtxefw2owm3/Amethyst_1.0.ipa?rlkey=1qcz9ymtvh4ok2u3qg10sv4jp&st=cuxsboop&dl=1"

      # Appstore++
      appstore_header:
        description: "ðŸ“± Appstore++"
        required: false
      update_appstoreplus:
        description: "Update Appstore++"
        type: boolean
        default: false
      appstoreplus_version:
        description: "Appstore++ Version"
        default: "1.0.3"
      appstoreplus_download_url:
        description: "Appstore++ Download URL"
        default: "https://www.dropbox.com/scl/fi/xh8zgttdb7dqllsaoi6ms/AppStore-_TrollStore_v1.0.3-2.ipa?rlkey=nsiodb3ym9tbubbwt00pyf6f6&st=vdfq72w4&dl=1"

      # iTorrent
      itorrent_header:
        description: "ðŸ“¥ iTorrent"
        required: false
      update_itorrent:
        description: "Update iTorrent"
        type: boolean
        default: false
      itorrent_version:
        description: "iTorrent Version"
        default: "2.0.15"
      itorrent_download_url:
        description: "iTorrent Download URL"
        default: "https://www.dropbox.com/scl/fi/01ai1w6kys71w9vwc1rwx/iTorrent.ipa?rlkey=4fv25wqm6gcr6r7qrai7bskcv&st=kmctvyqe&dl=1"

      # LiveContainer
      livecontainer_header:
        description: "ðŸ“¦ LiveContainer"
        required: false
      update_livecontainer:
        description: "Update LiveContainer"
        type: boolean
        default: false
      livecontainer_version:
        description: "LiveContainer Version"
        default: "3.6.1"
      livecontainer_download_url:
        description: "LiveContainer Download URL"
        default: "https://www.dropbox.com/scl/fi/nxn4nkeewe28gsm30xzc4/LiveContainer.ipa?rlkey=bcphsexwvc9gqwguncbioqp3z&st=f1kozixc&dl=1"

      # ModMyIpa
      modmyipa_header:
        description: "ðŸ”§ ModMyIpa"
        required: false
      update_modmyipa:
        description: "Update ModMyIpa"
        type: boolean
        default: false
      modmyipa_version:
        description: "ModMyIpa Version"
        default: "1.0.2"
      modmyipa_download_url:
        description: "ModMyIpa Download URL"
        default: "https://www.dropbox.com/scl/fi/pzuym7yzic75l686jb4n7/ModMyIPA-1.0.2.ipa?rlkey=fnxf3sk42qmf4zxhk0s90mqkh&st=x8funnj6&dl=1"

      # SuperMario64
      mario_header:
        description: "ðŸ„ SuperMario64"
        required: false
      update_supermario64:
        description: "Update SuperMario64"
        type: boolean
        default: false
      supermario64_version:
        description: "SuperMario64 Version"
        default: "1.2.1"
      supermario64_download_url:
        description: "SuperMario64 Download URL"
        default: "https://www.dropbox.com/scl/fi/b5yy47jalqfl71sqbig1z/SuperMario64_60FPS_1.2.1.ipa?rlkey=6kn7ltztrtcumf5fghqdwotrk&st=l6ks3vdw&dl=1"

      # Options
      options_header:
        description: "âš™ï¸ Options"
        required: false
      change_description:
        description: "Custom commit message (optional)"
        default: ""

jobs:
  repository-sync:
    name: "ðŸ”„ Sync App Repository"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref }}

      - name: "ðŸ” Validate JSON files"
        run: |
          set -euo pipefail
          echo "ðŸ” Validating JSON file structure..."
          
          for file in sidestore.json feather.json trollapps.json; do
            if [[ ! -f "$file" ]]; then
              echo "âŒ $file - File not found"
              exit 1
            fi
            
            if ! jq empty "$file" 2>/dev/null; then
              echo "âŒ $file - Invalid JSON structure"
              exit 1
            else
              echo "âœ… $file - Valid JSON"
            fi
          done

      - name: "ðŸ”„ Update repository files"
        id: update-files
        run: |
          set -euo pipefail
          CURRENT_DATE=$(date -u +"%Y-%m-%d")
          echo "current_date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          
          # Function to safely update app in JSON file
          update_app_in_file() {
            local file="$1"
            local app_name="$2"
            local bundle_id="$3"
            local version="$4"
            local download_url="$5"
            local tweak_version="$6"
            local temp_file="${file}.tmp.$$"
            
            echo "ðŸ”„ Updating $app_name in $file..."
            
            # Validate inputs
            if [[ -z "$version" || -z "$download_url" ]]; then
              echo "âŒ Missing version or download URL for $app_name"
              return 1
            fi
            
            # Generate localized description with updated versions
            local localized_desc
            case "$app_name" in
              "EeveeSpotify")
                localized_desc="Tweaked Spotify with premium features unlocked, no ads, and enhanced playback. Spotify v$version, EeveeSpotify $tweak_version."
                ;;
              "YTLite")
                localized_desc="Tweaked YouTube with background playback, no ads, and picture-in-picture. Youtube v$version, YTLite $tweak_version."
                ;;
              "X (NeoFreeBird)")
                localized_desc="Tweaked Twitter/X with premium features and more. X v$version, NeoFreeBird $tweak_version."
                ;;
              *)
                # For apps without version numbers in description, keep original text
                localized_desc=$(jq -r --arg app "$app_name" --arg bundle "$bundle_id" \
                  '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)).localizedDescription // ""' "$file")
                if [[ -z "$localized_desc" ]]; then
                  echo "âš ï¸  Could not find existing description for $app_name, keeping original"
                  localized_desc=$(jq -r --arg app "$app_name" --arg bundle "$bundle_id" \
                    '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)).localizedDescription' "$file" 2>/dev/null || echo "")
                fi
                ;;
            esac
            
            # Update based on file structure with proper error handling
            if [[ "$file" == "sidestore.json" ]]; then
              if ! jq --arg app "$app_name" \
                      --arg bundle "$bundle_id" \
                      --arg version "$version" \
                      --arg url "$download_url" \
                      --arg desc "$localized_desc" \
                      --arg date "$CURRENT_DATE" \
                      '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                        (.versions[0].version = $version |
                         .versions[0].downloadURL = $url |
                         .versions[0].date = $date |
                         .localizedDescription = $desc)' "$file" > "$temp_file"; then
                echo "âŒ Failed to update $app_name in $file"
                rm -f "$temp_file"
                return 1
              fi
                  
            elif [[ "$file" == "feather.json" ]]; then
              if ! jq --arg app "$app_name" \
                      --arg bundle "$bundle_id" \
                      --arg version "$version" \
                      --arg url "$download_url" \
                      --arg desc "$localized_desc" \
                      --arg date "$CURRENT_DATE" \
                      '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                        (.version = $version |
                         .downloadURL = $url |
                         .versionDate = $date |
                         .localizedDescription = $desc |
                         .versions[0].version = $version |
                         .versions[0].downloadURL = $url |
                         .versions[0].date = $date)' "$file" > "$temp_file"; then
                echo "âŒ Failed to update $app_name in $file"
                rm -f "$temp_file"
                return 1
              fi
                  
            else  # trollapps.json
              if ! jq --arg app "$app_name" \
                      --arg bundle "$bundle_id" \
                      --arg version "$version" \
                      --arg url "$download_url" \
                      --arg desc "$localized_desc" \
                      --arg date "$CURRENT_DATE" \
                      '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                        (.version = $version |
                         .downloadURL = $url |
                         .versionDate = $date |
                         .localizedDescription = $desc)' "$file" > "$temp_file"; then
                echo "âŒ Failed to update $app_name in $file"
                rm -f "$temp_file"
                return 1
              fi
            fi
            
            # Validate the temp file before replacing original
            if ! jq empty "$temp_file" 2>/dev/null; then
              echo "âŒ Generated invalid JSON for $app_name in $file"
              rm -f "$temp_file"
              return 1
            fi
            
            mv "$temp_file" "$file" || {
              echo "âŒ Failed to replace $file"
              return 1
            }
            
            echo "âœ… Successfully updated $app_name in $file"
          }

          # Initialize updated apps array
          UPDATED_APPS=()
          
          # Update apps based on toggles with proper conditional execution
          if [[ "${{ inputs.update_eeveespotify }}" == "true" ]]; then
            UPDATED_APPS+=("EeveeSpotify")
            for file in sidestore.json feather.json trollapps.json; do
              update_app_in_file "$file" "EeveeSpotify" "com.spotify.client" \
                "${{ inputs.eeveespotify_version }}" "${{ inputs.eeveespotify_download_url }}" "${{ inputs.eeveespotify_tweak_version }}" || exit 1
            done
          fi

          if [[ "${{ inputs.update_ytlite }}" == "true" ]]; then
            UPDATED_APPS+=("YTLite")
            for file in sidestore.json feather.json trollapps.json; do
              update_app_in_file "$file" "YTLite" "com.google.ios.youtube" \
                "${{ inputs.ytlite_version }}" "${{ inputs.ytlite_download_url }}" "${{ inputs.ytlite_tweak_version }}" || exit 1
            done
          fi

          if [[ "${{ inputs.update_x_neofreebird }}" == "true" ]]; then
            UPDATED_APPS+=("X (NeoFreeBird)")
            for file in sidestore.json feather.json trollapps.json; do
              update_app_in_file "$file" "X (NeoFreeBird)" "com.atebits.Tweetie2" \
                "${{ inputs.x_neofreebird_version }}" "${{ inputs.x_neofreebird_download_url }}" "${{ inputs.x_neofreebird_tweak_version }}" || exit 1
            done
          fi

          # Apps without version numbers in description
          if [[ "${{ inputs.update_inshotpro }}" == "true" ]]; then
            UPDATED_APPS+=("InshotPro")
            for file in sidestore.json feather.json trollapps.json; do
              update_app_in_file "$file" "InshotPro" "com.camerasideas.InstaShot" \
                "${{ inputs.inshotpro_version }}" "${{ inputs.inshotpro_download_url }}" "" || exit 1
            done
          fi

          if [[ "${{ inputs.update_refacepro }}" == "true" ]]; then
            UPDATED_APPS+=("RefacePro")
            for file in sidestore.json feather.json trollapps.json; do
              update_app_in_file "$file" "RefacePro (IOS 17+)" "com.neocortext.doublicatapp" \
                "${{ inputs.refacepro_version }}" "${{ inputs.refacepro_download_url }}" "" || exit 1
            done
          fi

          if [[ "${{ inputs.update_amethyst }}" == "true" ]]; then
            UPDATED_APPS+=("Amethyst")
            for file in sidestore.json feather.json trollapps.json; do
              update_app_in_file "$file" "Amethyst" "com.angelauramc.amethyst" \
                "${{ inputs.amethyst_version }}" "${{ inputs.amethyst_download_url }}" "" || exit 1
            done
          fi

          if [[ "${{ inputs.update_appstoreplus }}" == "true" ]]; then
            UPDATED_APPS+=("Appstore++")
            for file in sidestore.json feather.json trollapps.json; do
              update_app_in_file "$file" "Appstore++" "com.cokepokes.AppStorePlus" \
                "${{ inputs.appstoreplus_version }}" "${{ inputs.appstoreplus_download_url }}" "" || exit 1
            done
          fi

          if [[ "${{ inputs.update_itorrent }}" == "true" ]]; then
            UPDATED_APPS+=("iTorrent")
            for file in sidestore.json feather.json trollapps.json; do
              update_app_in_file "$file" "iTorrent (IOS 17+)" "org.xitrix.iTorrent2" \
                "${{ inputs.itorrent_version }}" "${{ inputs.itorrent_download_url }}" "" || exit 1
            done
          fi

          if [[ "${{ inputs.update_livecontainer }}" == "true" ]]; then
            UPDATED_APPS+=("LiveContainer")
            for file in sidestore.json feather.json trollapps.json; do
              update_app_in_file "$file" "LiveContainer" "com.kdt.livecontainer" \
                "${{ inputs.livecontainer_version }}" "${{ inputs.livecontainer_download_url }}" "" || exit 1
            done
          fi

          if [[ "${{ inputs.update_modmyipa }}" == "true" ]]; then
            UPDATED_APPS+=("ModMyIpa")
            for file in sidestore.json feather.json trollapps.json; do
              update_app_in_file "$file" "ModMyIpa" "com.powenn.ModMyIPA" \
                "${{ inputs.modmyipa_version }}" "${{ inputs.modmyipa_download_url }}" "" || exit 1
            done
          fi

          if [[ "${{ inputs.update_supermario64 }}" == "true" ]]; then
            UPDATED_APPS+=("SuperMario64")
            for file in sidestore.json feather.json trollapps.json; do
              update_app_in_file "$file" "SuperMario64 (60fps)" "xyz.cypwn.sm64ios-60fps" \
                "${{ inputs.supermario64_version }}" "${{ inputs.supermario64_download_url }}" "" || exit 1
            done
          fi

          # Output updated apps as JSON array to handle spaces in names
          if [[ ${#UPDATED_APPS[@]} -gt 0 ]]; then
            printf -v apps_json '%s,' "${UPDATED_APPS[@]}"
            echo "updated_apps=[${apps_json%,}]" >> $GITHUB_OUTPUT
          else
            echo "updated_apps=[]" >> $GITHUB_OUTPUT
          fi

      - name: "âœ… Verify changes"
        run: |
          set -euo pipefail
          echo "ðŸ” Verifying updated files..."
          for file in sidestore.json feather.json trollapps.json; do
            if jq empty "$file" 2>/dev/null; then
              echo "âœ… $file - Valid JSON after updates"
            else
              echo "âŒ $file - Invalid JSON after updates"
              exit 1
            fi
          done

      - name: "ðŸ“ Commit and push changes"
        if: steps.update-files.outputs.updated_apps != '[]'
        run: |
          set -euo pipefail
          
          # Get current branch
          CURRENT_BRANCH=${GITHUB_REF#refs/heads/}
          echo "ðŸ“‹ Current branch: $CURRENT_BRANCH"
          
          # Generate commit message
          if [[ -n "${{ inputs.change_description }}" ]]; then
            COMMIT_MSG="${{ inputs.change_description }}"
          else
            # Parse updated apps from JSON output
            UPDATED_APPS_JSON='${{ steps.update-files.outputs.updated_apps }}'
            UPDATED_APPS=$(echo "$UPDATED_APPS_JSON" | jq -r '.[]' 2>/dev/null || echo "")
            
            COMMIT_MSG="ðŸ”„ Repository Sync: Updated app versions across all sources"
            
            if [[ -n "$UPDATED_APPS" ]]; then
              COMMIT_MSG+="\n\nUpdated apps:"
              while IFS= read -r app; do
                COMMIT_MSG+="\nâ€¢ $app"
              done <<< "$UPDATED_APPS"
            fi
            
            COMMIT_MSG+="\n\nðŸ¤– Automated update via GitHub Actions"
          fi
          
          # Configure git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git config --local push.default simple
          
          # Stage changes
          git add sidestore.json feather.json trollapps.json
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit."
          else
            echo "ðŸ’¾ Committing changes..."
            git commit -m "$(echo -e "$COMMIT_MSG")"
            
            echo "ðŸš€ Pushing changes to $CURRENT_BRANCH..."
            git push origin "HEAD:$CURRENT_BRANCH"
            echo "âœ… Changes committed and pushed successfully"
          fi

      - name: "ðŸ“Š Update summary"
        run: |
          echo "## ðŸŽ¯ Repository Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Files Updated:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… sidestore.json" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… feather.json" >> $GITHUB_STEP_SUMMARY  
          echo "- âœ… trollapps.json" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          UPDATED_APPS_JSON='${{ steps.update-files.outputs.updated_apps }}'
          if [[ "$UPDATED_APPS_JSON" != "[]" ]]; then
            echo "### ðŸ“± Apps Updated:" >> $GITHUB_STEP_SUMMARY
            echo "$UPDATED_APPS_JSON" | jq -r '.[]' | while read -r app; do
              echo "- ðŸŽ¯ $app" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "### â„¹ï¸ No apps were updated (all toggles were off)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Automated repository management* ðŸ¤–" >> $GITHUB_STEP_SUMMARY