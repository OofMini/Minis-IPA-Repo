name: Bulk IPA Updates

on:
  workflow_dispatch:
    inputs:
      update_spotify:
        description: "Update Spotify"
        type: boolean
        default: false
      spotify_ipa_version:
        description: "Spotify IPA Version:"
        default: "9.0.96"
      spotify_tweak_version:
        description: "Spotify Tweak Version:"
        default: "v6.2.2"
      update_youtube:
        description: "Update YouTube"
        type: boolean
        default: false
      youtube_ipa_version:
        description: "YouTube IPA Version:"
        default: "20.45.3"
      youtube_tweak_version:
        description: "YouTube Tweak Version:"
        default: "v5.2b4"
      update_x:
        description: "Update X"
        type: boolean
        default: false
      x_ipa_version:
        description: "X IPA Version:"
        default: "11.38.1"
      x_tweak_version:
        description: "X Tweak Version:"
        default: "v5.2"
      change_description:
        description: "Custom commit message (optional)"
        default: ""

jobs:
  repository-sync:
    name: "Sync App Repository"
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Process repository updates"
        id: update-files
        run: |
          set -e
          
          # Install dependencies and setup
          sudo apt-get update && sudo apt-get install -y jq
          CURRENT_DATE=$(date -u +"%Y-%m-%d")
          echo "current_date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          
          # Function to build download URL
          build_download_info() {
            case "$1" in
              "EeveeSpotify") echo "https://github.com/OofMini/eeveespotifyreborn/releases/download/New/EeveeSpotify.ipa" ;;
              "YTLite") echo "https://github.com/OofMini/YTLite/releases/download/New/YouTubePlus_${2#v}.ipa" ;;
              "X (NeoFreeBird)") echo "https://github.com/OofMini/tweak/releases/download/New/NeoFreeBird-sideloaded.ipa" ;;
              *) echo "Unknown app: $1"; exit 1 ;;
            esac
          }
          
          # Validate JSON files
          echo "Validating JSON files..."
          for file in sidestore.json feather.json trollapps.json; do
            [ -f "$file" ] && jq empty "$file" && echo "‚úÖ $file - Valid JSON" || { echo "‚ùå $file - Invalid JSON"; exit 1; }
            jq -e '.apps | type == "array"' "$file" >/dev/null || { echo "‚ùå $file - Missing apps array"; exit 1; }
          done
          
          # Function to update app in JSON file
          update_app_in_file() {
            local file="$1" app_name="$2" bundle_id="$3" ipa_version="$4" tweak_version="$5"
            local download_url=$(build_download_info "$app_name" "$tweak_version")
            local temp_file="${file}.tmp"
            
            echo "Updating $app_name in $file..."
            
            # Generate description
            case "$app_name" in
              "EeveeSpotify") local desc="Tweaked Spotify with premium features unlocked, no ads, and enhanced playback. Spotify IPA $ipa_version, EeveeSpotify $tweak_version." ;;
              "YTLite") local desc="Tweaked YouTube with background playback, no ads, and picture-in-picture. YouTube IPA $ipa_version, YTLite $tweak_version." ;;
              "X (NeoFreeBird)") local desc="Tweaked X with premium features and more. X IPA $ipa_version, NeoFreeBird $tweak_version." ;;
              *) local desc=$(jq -r --arg app "$app_name" --arg bundle "$bundle_id" '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)).localizedDescription // "Tweaked application with enhanced features."' "$file") ;;
            esac
            
            # Update based on file structure
            case "$file" in
              "sidestore.json")
                jq --arg app "$app_name" --arg bundle "$bundle_id" --arg version "$ipa_version" \
                   --arg url "$download_url" --arg desc "$desc" --arg date "$CURRENT_DATE" \
                   '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                    (.versions[0].version = $version | .versions[0].downloadURL = $url | 
                     .versions[0].date = $date | .localizedDescription = $desc)' "$file" > "$temp_file"
                ;;
              "feather.json")
                jq --arg app "$app_name" --arg bundle "$bundle_id" --arg version "$ipa_version" \
                   --arg url "$download_url" --arg desc "$desc" --arg date "$CURRENT_DATE" \
                   '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                    (.version = $version | .downloadURL = $url | .versionDate = $date |
                     .versions[0].version = $version | .versions[0].downloadURL = $url | 
                     .versions[0].date = $date | .localizedDescription = $desc)' "$file" > "$temp_file"
                ;;
              "trollapps.json")
                jq --arg app "$app_name" --arg bundle "$bundle_id" --arg version "$ipa_version" \
                   --arg url "$download_url" --arg desc "$desc" \
                   '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                    (.version = $version | .downloadURL = $url | .localizedDescription = $desc)' "$file" > "$temp_file"
                ;;
            esac
            
            # Verify and replace
            [ -f "$temp_file" ] && jq empty "$temp_file" && mv "$temp_file" "$file" && echo "‚úÖ Updated $app_name in $file"
          }

          # Initialize updated apps array
          UPDATED_APPS=()
          UPDATED_VERSIONS=()
          
          # Update apps based on individual toggles
          if [[ "${{ github.event.inputs.update_spotify }}" == "true" ]]; then
            echo "üîÑ Processing Spotify update..."
            IPA="${{ github.event.inputs.spotify_ipa_version }}"
            TWEAK="${{ github.event.inputs.spotify_tweak_version }}"
            
            for file in sidestore.json feather.json trollapps.json; do
              update_app_in_file "$file" "EeveeSpotify" "com.spotify.client" "$IPA" "$TWEAK"
            done
            UPDATED_APPS+=("EeveeSpotify")
            UPDATED_VERSIONS+=("spotify:$IPA:$TWEAK")
          fi

          if [[ "${{ github.event.inputs.update_youtube }}" == "true" ]]; then
            echo "üîÑ Processing YouTube update..."
            IPA="${{ github.event.inputs.youtube_ipa_version }}"
            TWEAK="${{ github.event.inputs.youtube_tweak_version }}"
            
            for file in sidestore.json feather.json trollapps.json; do
              update_app_in_file "$file" "YTLite" "com.google.ios.youtube" "$IPA" "$TWEAK"
            done
            UPDATED_APPS+=("YTLite")
            UPDATED_VERSIONS+=("youtube:$IPA:$TWEAK")
          fi

          if [[ "${{ github.event.inputs.update_x }}" == "true" ]]; then
            echo "üîÑ Processing X update..."
            IPA="${{ github.event.inputs.x_ipa_version }}"
            TWEAK="${{ github.event.inputs.x_tweak_version }}"
            
            for file in sidestore.json feather.json trollapps.json; do
              update_app_in_file "$file" "X (NeoFreeBird)" "com.atebits.Tweetie2" "$IPA" "$TWEAK"
            done
            UPDATED_APPS+=("X (NeoFreeBird)")
            UPDATED_VERSIONS+=("x:$IPA:$TWEAK")
          fi

          # Output updated apps for subsequent steps
          if [ ${#UPDATED_APPS[@]} -gt 0 ]; then
            echo "updated_apps=${UPDATED_APPS[*]}" >> $GITHUB_OUTPUT
            echo "updated_versions=${UPDATED_VERSIONS[*]}" >> $GITHUB_OUTPUT
            echo "‚úÖ Updated apps: ${UPDATED_APPS[*]}"
          else
            echo "‚ÑπÔ∏è No apps selected for update"
          fi
          
          # Final validation
          for file in sidestore.json feather.json trollapps.json; do
            jq empty "$file" || { echo "‚ùå Final validation failed for $file"; exit 1; }
          done

      - name: "Update web files"
        if: steps.update-files.outputs.updated_versions
        run: |
          set -e
          UPDATED_VERSIONS_STR="${{ steps.update-files.outputs.updated_versions }}"
          [ -z "$UPDATED_VERSIONS_STR" ] && exit 0
          
          IFS=' ' read -ra VERSION_PAIRS <<< "$UPDATED_VERSIONS_STR"
          
          # Update index.html
          if [ -f "index.html" ]; then
            echo "Updating index.html..."
            for version_pair in "${VERSION_PAIRS[@]}"; do
              IFS=':' read -ra PARTS <<< "$version_pair"
              APP="${PARTS[0]}"
              IPA_VERSION="${PARTS[1]}"
              TWEAK_VERSION="${PARTS[2]}"
              
              case "$APP" in
                "spotify")
                  sed -i -e "/id: 'eeveespotify'/,/},/{s/version: '[0-9][0-9.]*',/version: '$IPA_VERSION',/}" \
                         -e "/id: 'eeveespotify'/,/},/{s|Spotify IPA [0-9][0-9.]*, EeveeSpotify v[0-9a-z.]*|Spotify IPA $IPA_VERSION, EeveeSpotify $TWEAK_VERSION|}" \
                         "index.html"
                  ;;
                "youtube")
                  sed -i -e "/id: 'ytlite'/,/},/{s/version: '[0-9][0-9.]*',/version: '$IPA_VERSION',/}" \
                         -e "/id: 'ytlite'/,/},/{s|YouTube IPA [0-9][0-9.]*, YTLite v[0-9a-z.]*|YouTube IPA $IPA_VERSION, YTLite $TWEAK_VERSION|}" \
                         "index.html"
                  ;;
                "x")
                  sed -i -e "/id: 'neofreebird'/,/},/{s/version: '[0-9][0-9.]*',/version: '$IPA_VERSION',/}" \
                         -e "/id: 'neofreebird'/,/},/{s|X IPA [0-9][0-9.]*, NeoFreeBird v[0-9a-z.]*|X IPA $IPA_VERSION, NeoFreeBird $TWEAK_VERSION|}" \
                         "index.html"
                  ;;
              esac
            done
            echo "‚úÖ Updated index.html"
          fi

      - name: "Commit and push changes"
        if: steps.update-files.outputs.updated_apps
        run: |
          set -e
          
          # Generate commit message
          if [[ -n "${{ github.event.inputs.change_description }}" ]]; then
            COMMIT_MSG="${{ github.event.inputs.change_description }}"
          else
            COMMIT_MSG="Repository Sync: Updated app versions across all sources"
            UPDATED_APPS_STR="${{ steps.update-files.outputs.updated_apps }}"
            if [ -n "$UPDATED_APPS_STR" ]; then
              IFS=' ' read -ra UPDATED_APPS_ARR <<< "$UPDATED_APPS_STR"
              COMMIT_MSG="$COMMIT_MSG\n\nUpdated apps:"
              for app in "${UPDATED_APPS_ARR[@]}"; do
                COMMIT_MSG="$COMMIT_MSG\n‚Ä¢ $app"
              done
            fi
            COMMIT_MSG="$COMMIT_MSG\n\nAutomated update via GitHub Actions"
          fi
          
          # Configure git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add changed files
          git add sidestore.json feather.json trollapps.json index.html
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit - files are already up to date"
          else
            git commit -m "$(echo -e "$COMMIT_MSG")"
            git push
            echo "‚úÖ Changes committed and pushed successfully"
          fi

      - name: "Update summary"
        run: |
          {
            echo "## Repository Update Summary"
            echo ""
            echo "### Apps Updated:"
            UPDATED_APPS_STR="${{ steps.update-files.outputs.updated_apps }}"
            if [ -n "$UPDATED_APPS_STR" ]; then
              IFS=' ' read -ra UPDATED_APPS_ARR <<< "$UPDATED_APPS_STR"
              for app in "${UPDATED_APPS_ARR[@]}"; do
                echo "- $app"
              done
            else
              echo "No apps were updated (all toggles were off or no changes detected)"
            fi
            
            echo ""
            echo "### Files Updated:"
            echo "- sidestore.json"
            echo "- feather.json"  
            echo "- trollapps.json"
            echo "- index.html"
            
            echo ""
            echo "---"
            echo "Automated repository management"
          } >> $GITHUB_STEP_SUMMARY