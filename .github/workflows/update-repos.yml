name: üöÄ Repository Manager - Bulk App Updates

on:
  workflow_dispatch:
    inputs:
      apps_config:
        description: 'App configurations as JSON (edit update: true/false for each app)'
        required: true
        default: '{
          "eeveespotify": {"update": false, "version": "9.0.91", "tweak_version": "v6.2", "download_url": "https://github.com/OofMini/eeveespotifyreborn/releases/download/New/EeveeSpotify.ipa"},
          "ytlite": {"update": false, "version": "20.44.2", "tweak_version": "v5.2b4", "download_url": "https://github.com/OofMini/YTLite/releases/download/New/YouTubePlus_5.2b4.ipa"},
          "x_neofreebird": {"update": false, "version": "11.36", "tweak_version": "v5.2", "download_url": "https://github.com/OofMini/tweak/releases/download/New/NeoFreeBird-sideloaded.ipa"},
          "inshotpro": {"update": false, "version": "1.90.2", "download_url": "https://www.dropbox.com/scl/fi/z9pg3t8e5rkauyh51duud/InShot-ipaomtk.com.ipa?rlkey=whj0y0ex86tondgcdn9t7dxnv&st=nzcaijfi&dl=1"},
          "refacepro": {"update": false, "version": "5.23.0", "download_url": "https://www.dropbox.com/scl/fi/kaffbspyr1672l2okzpv5/Reface.ipa?rlkey=fp1f4xhxl0j439s9ub0pkvrtt&st=iu6ldqpw&dl=1"},
          "amethyst": {"update": false, "version": "1.0", "download_url": "https://www.dropbox.com/scl/fi/j2pk7iaiodrtxefw2owm3/Amethyst_1.0.ipa?rlkey=1qcz9ymtvh4ok2u3qg10sv4jp&st=cuxsboop&dl=1"},
          "appstoreplus": {"update": false, "version": "1.0.3", "download_url": "https://www.dropbox.com/scl/fi/xh8zgttdb7dqllsaoi6ms/AppStore-_TrollStore_v1.0.3-2.ipa?rlkey=nsiodb3ym9tbubbwt00pyf6f6&st=vdfq72w4&dl=1"},
          "itorrent": {"update": false, "version": "2.0.15", "download_url": "https://www.dropbox.com/scl/fi/01ai1w6kys71w9vwc1rwx/iTorrent.ipa?rlkey=4fv25wqm6gcr6r7qrai7bskcv&st=kmctvyqe&dl=1"},
          "livecontainer": {"update": false, "version": "3.6.1", "download_url": "https://www.dropbox.com/scl/fi/nxn4nkeewe28gsm30xzc4/LiveContainer.ipa?rlkey=bcphsexwvc9gqwguncbioqp3z&st=f1kozixc&dl=1"},
          "modmyipa": {"update": false, "version": "1.0.2", "download_url": "https://www.dropbox.com/scl/fi/pzuym7yzic75l686jb4n7/ModMyIPA-1.0.2.ipa?rlkey=fnxf3sk42qmf4zxhk0s90mqkh&st=x8funnj6&dl=1"},
          "supermario64": {"update": false, "version": "1.2.1", "download_url": "https://www.dropbox.com/scl/fi/b5yy47jalqfl71sqbig1z/SuperMario64_60FPS_1.2.1.ipa?rlkey=6kn7ltztrtcumf5fghqdwotrk&st=l6ks3vdw&dl=1"}
        }'
      change_description:
        description: 'Custom commit message (optional)'
        required: false
        default: ''

jobs:
  repository-sync:
    name: "üîÑ Sync App Repository"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: "üì• Checkout repository"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref }}

      - name: "üîç Validate JSON files"
        id: validate-json
        run: |
          set -euo pipefail
          echo "üîç Validating JSON file structure..."
          
          for file in sidestore.json feather.json trollapps.json; do
            if [[ ! -f "$file" ]]; then
              echo "::error file=$file::File not found"
              exit 1
            fi
            
            if ! jq empty "$file" 2>/dev/null; then
              echo "::error file=$file::Invalid JSON structure"
              exit 1
            else
              echo "‚úÖ $file - Valid JSON"
            fi
          done

      - name: "üìã Parse app configurations"
        id: parse-config
        run: |
          set -euo pipefail
          
          # Validate input JSON
          if ! echo '${{ github.event.inputs.apps_config }}' | jq empty 2>/dev/null; then
            echo "::error::Invalid apps_config JSON input"
            exit 1
          fi
          
          CONFIG_JSON='${{ github.event.inputs.apps_config }}'
          echo "üîß Parsing app configurations..."
          
          # Create a mapping for app names and bundle IDs
          declare -A APP_MAPPING=(
            ["eeveespotify"]="EeveeSpotify|com.spotify.client"
            ["ytlite"]="YTLite|com.google.ios.youtube" 
            ["x_neofreebird"]="X (NeoFreeBird)|com.atebits.Tweetie2"
            ["inshotpro"]="InshotPro|com.camerasideas.InstaShot"
            ["refacepro"]="RefacePro (IOS 17+)|com.neocortext.doublicatapp"
            ["amethyst"]="Amethyst|com.angelauramc.amethyst"
            ["appstoreplus"]="Appstore++|com.cokepokes.AppStorePlus"
            ["itorrent"]="iTorrent (IOS 17+)|org.xitrix.iTorrent2"
            ["livecontainer"]="LiveContainer|com.kdt.livecontainer"
            ["modmyipa"]="ModMyIpa|com.powenn.ModMyIPA"
            ["supermario64"]="SuperMario64 (60fps)|xyz.cypwn.sm64ios-60fps"
          )
          
          # Process each app configuration
          UPDATED_APPS=()
          APP_KEYS=("eeveespotify" "ytlite" "x_neofreebird" "inshotpro" "refacepro" "amethyst" "appstoreplus" "itorrent" "livecontainer" "modmyipa" "supermario64")
          
          # Create a config file with all app data
          CONFIG_DATA=""
          
          for app_key in "${APP_KEYS[@]}"; do
            # Check if app exists in config
            if ! echo "$CONFIG_JSON" | jq -e ".[\"$app_key\"]" > /dev/null 2>&1; then
              echo "‚ö†Ô∏è  App '$app_key' not found in configuration, skipping"
              continue
            fi
            
            update_flag=$(echo "$CONFIG_JSON" | jq -r --arg key "$app_key" '.[$key].update // false')
            
            if [[ "$update_flag" == "true" ]]; then
              if [[ -z "${APP_MAPPING[$app_key]:-}" ]]; then
                echo "::error::Unknown app key: $app_key"
                exit 1
              fi
              
              IFS='|' read -r app_name bundle_id <<< "${APP_MAPPING[$app_key]}"
              UPDATED_APPS+=("$app_name")
              
              version=$(echo "$CONFIG_JSON" | jq -r --arg key "$app_key" '.[$key].version // ""')
              download_url=$(echo "$CONFIG_JSON" | jq -r --arg key "$app_key" '.[$key].download_url // ""')
              tweak_version=$(echo "$CONFIG_JSON" | jq -r --arg key "$app_key" '.[$key].tweak_version // ""')
              
              # Validate required fields
              if [[ -z "$version" || -z "$download_url" ]]; then
                echo "::error::Missing version or download_url for $app_name"
                exit 1
              fi
              
              # Add to config data
              CONFIG_DATA+="$app_key|$app_name|$bundle_id|$version|$download_url|$tweak_version"$'\n'
              echo "‚úÖ $app_name queued for update (v$version)"
            else
              echo "‚è≠Ô∏è  $app_key update skipped"
            fi
          done
          
          # Save config data to file
          echo "$CONFIG_DATA" > "app_updates.config"
          echo "üìÅ Saved app update configuration to file"
          
          # Output updated apps as JSON array
          if [[ ${#UPDATED_APPS[@]} -gt 0 ]]; then
            printf -v apps_json '"%s",' "${UPDATED_APPS[@]}"
            echo "updated_apps=[${apps_json%,}]" >> $GITHUB_OUTPUT
            echo "üì¶ Apps to update: ${UPDATED_APPS[*]}"
          else
            echo "updated_apps=[]" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No apps selected for update"
          fi

      - name: "üîÑ Update repository files"
        id: update-files
        run: |
          set -euo pipefail
          CURRENT_DATE=$(date -u +"%Y-%m-%d")
          echo "current_date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "üìÖ Using date: $CURRENT_DATE"
          
          # Function to safely update app in JSON file
          update_app_in_file() {
            local file="$1"
            local app_name="$2"
            local bundle_id="$3"
            local version="$4"
            local download_url="$5"
            local tweak_version="$6"
            local temp_file="${file}.tmp.$$"
            
            echo "üîß Updating $app_name in $file..."
            
            # Use the exact localized descriptions from sidestore.json
            local localized_desc
            case "$app_name" in
              "EeveeSpotify")
                localized_desc="Tweaked Spotify with premium features unlocked, no ads, and enhanced playback. Spotify v$version, EeveeSpotify $tweak_version."
                ;;
              "YTLite")
                localized_desc="Tweaked YouTube with background playback, no ads, and picture-in-picture. Youtube v$version, YTLite $tweak_version."
                ;;
              "X (NeoFreeBird)")
                localized_desc="Tweaked Twitter/X with premium features and more. X v$version, NeoFreeBird $tweak_version."
                ;;
              "InshotPro")
                localized_desc="Pro video editor with premium filters, tools, and no watermark. App v$version."
                ;;
              "RefacePro (IOS 17+)")
                localized_desc="Reface Premium Unloked."
                ;;
              "Amethyst")
                localized_desc="Minecraft Java IOS Edition."
                ;;
              "Appstore++")
                localized_desc="Appstore++ allows users to downgrade apps."
                ;;
              "iTorrent (IOS 17+)")
                localized_desc="Lightweight torrent client for downloading and managing torrent files on-device."
                ;;
              "LiveContainer")
                localized_desc="Runs live production containers for streaming apps and runtime isolation."
                ;;
              "ModMyIpa")
                localized_desc="Tool for modifying .ipas and duplicating apps."
                ;;
              "SuperMario64 (60fps)")
                localized_desc="Patched Super Mario 64 with unlocked 60 FPS rendering for smoother gameplay."
                ;;
              *)
                # Fallback to reading from the file if app name doesn't match
                localized_desc=$(jq -r --arg app "$app_name" --arg bundle "$bundle_id" \
                  '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)).localizedDescription // ""' "$file" 2>/dev/null || echo "")
                if [[ -z "$localized_desc" ]]; then
                  echo "‚ö†Ô∏è  Could not find existing description for $app_name, using fallback"
                  localized_desc="$app_name - Updated to version $version"
                fi
                ;;
            esac
            
            # Update based on file structure with proper error handling
            local jq_success=true
            if [[ "$file" == "sidestore.json" ]]; then
              if ! jq --arg app "$app_name" \
                      --arg bundle "$bundle_id" \
                      --arg version "$version" \
                      --arg url "$download_url" \
                      --arg desc "$localized_desc" \
                      --arg date "$CURRENT_DATE" \
                      '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                        (.versions[0].version = $version |
                         .versions[0].downloadURL = $url |
                         .versions[0].date = $date |
                         .localizedDescription = $desc)' "$file" > "$temp_file" 2>/dev/null; then
                jq_success=false
              fi
                  
            elif [[ "$file" == "feather.json" ]]; then
              if ! jq --arg app "$app_name" \
                      --arg bundle "$bundle_id" \
                      --arg version "$version" \
                      --arg url "$download_url" \
                      --arg desc "$localized_desc" \
                      --arg date "$CURRENT_DATE" \
                      '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                        (.version = $version |
                         .downloadURL = $url |
                         .versionDate = $date |
                         .localizedDescription = $desc |
                         .versions[0].version = $version |
                         .versions[0].downloadURL = $url |
                         .versions[0].date = $date)' "$file" > "$temp_file" 2>/dev/null; then
                jq_success=false
              fi
                  
            else  # trollapps.json
              if ! jq --arg app "$app_name" \
                      --arg bundle "$bundle_id" \
                      --arg version "$version" \
                      --arg url "$download_url" \
                      --arg desc "$localized_desc" \
                      --arg date "$CURRENT_DATE" \
                      '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                        (.version = $version |
                         .downloadURL = $url |
                         .versionDate = $date |
                         .localizedDescription = $desc)' "$file" > "$temp_file" 2>/dev/null; then
                jq_success=false
              fi
            fi
            
            if [[ "$jq_success" != "true" ]]; then
              echo "::error file=$file::Failed to update $app_name in $file (jq error)"
              rm -f "$temp_file"
              return 1
            fi
            
            # Validate the temp file before replacing original
            if ! jq empty "$temp_file" 2>/dev/null; then
              echo "::error file=$file::Generated invalid JSON for $app_name"
              rm -f "$temp_file"
              return 1
            fi
            
            if ! mv "$temp_file" "$file"; then
              echo "::error file=$file::Failed to replace $file"
              return 1
            fi
            
            echo "‚úÖ Successfully updated $app_name in $file"
          }

          # Read app configurations from file and process updates
          UPDATE_COUNT=0
          
          if [[ ! -f "app_updates.config" ]]; then
            echo "‚ÑπÔ∏è  No app updates configured"
            echo "total_updates=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          while IFS='|' read -r app_key app_name bundle_id version download_url tweak_version; do
            if [[ -n "$app_key" && -n "$app_name" ]]; then
              echo "üîÑ Processing update for $app_name..."
              for file in sidestore.json feather.json trollapps.json; do
                if update_app_in_file "$file" "$app_name" "$bundle_id" "$version" "$download_url" "$tweak_version"; then
                  ((UPDATE_COUNT++))
                else
                  exit 1
                fi
              done
            fi
          done < "app_updates.config"
          
          # Clean up config file
          rm -f "app_updates.config"
          
          echo "total_updates=$UPDATE_COUNT" >> $GITHUB_OUTPUT
          echo "üéØ Completed $UPDATE_COUNT file updates across all apps"

      - name: "‚úÖ Verify changes"
        if: steps.parse-config.outputs.updated_apps != '[]'
        run: |
          set -euo pipefail
          echo "üîç Verifying updated files..."
          for file in sidestore.json feather.json trollapps.json; do
            if jq empty "$file" 2>/dev/null; then
              echo "‚úÖ $file - Valid JSON after updates"
            else
              echo "::error file=$file::Invalid JSON after updates"
              exit 1
            fi
          done

      - name: "üìù Commit and push changes"
        if: steps.parse-config.outputs.updated_apps != '[]'
        run: |
          set -euo pipefail
          
          # Get current branch
          CURRENT_BRANCH="${GITHUB_REF#refs/heads/}"
          echo "üìã Current branch: $CURRENT_BRANCH"
          
          # Generate commit message
          if [[ -n "${{ github.event.inputs.change_description }}" ]]; then
            COMMIT_MSG="${{ github.event.inputs.change_description }}"
          else
            # Parse updated apps from JSON output
            UPDATED_APPS_JSON='${{ steps.parse-config.outputs.updated_apps }}'
            UPDATED_APPS=$(echo "$UPDATED_APPS_JSON" | jq -r '.[]' 2>/dev/null || echo "")
            
            COMMIT_MSG="üîÑ Repository Sync: Updated app versions across all sources"
            
            if [[ -n "$UPDATED_APPS" ]]; then
              COMMIT_MSG+="\n\nUpdated apps:"
              while IFS= read -r app; do
                COMMIT_MSG+="\n‚Ä¢ $app"
              done <<< "$UPDATED_APPS"
            fi
            
            COMMIT_MSG+="\n\nü§ñ Automated update via GitHub Actions"
          fi
          
          # Configure git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git config --local push.default simple
          
          # Stage changes
          git add sidestore.json feather.json trollapps.json
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit."
          else
            echo "üíæ Committing changes..."
            git commit -m "$(echo -e "$COMMIT_MSG")"
            
            echo "üöÄ Pushing changes to $CURRENT_BRANCH..."
            git push origin "HEAD:$CURRENT_BRANCH"
            echo "‚úÖ Changes committed and pushed successfully"
          fi

      - name: "üìä Update summary"
        run: |
          echo "## üéØ Repository Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìÅ Files Updated:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ sidestore.json" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ feather.json" >> $GITHUB_STEP_SUMMARY  
          echo "- ‚úÖ trollapps.json" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          UPDATED_APPS_JSON='${{ steps.parse-config.outputs.updated_apps }}'
          if [[ "$UPDATED_APPS_JSON" != "[]" ]]; then
            echo "### üì± Apps Updated:" >> $GITHUB_STEP_SUMMARY
            echo "$UPDATED_APPS_JSON" | jq -r '.[]' | while read -r app; do
              echo "- üéØ $app" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Total file updates:** ${{ steps.update-files.outputs.total_updates }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ÑπÔ∏è No apps were updated (all toggles were off)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Automated repository management* ü§ñ" >> $GITHUB_STEP_SUMMARY