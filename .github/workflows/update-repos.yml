name: ðŸš€ Repository Manager - Bulk App Updates

on:
  workflow_dispatch:
    inputs:
      # App Selection
      app_selection:
        description: "Select Apps to Update"
        type: choice
        options:
        - "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        - "ðŸŽµ Spotify"
        - "ðŸ“º YouTube" 
        - "ðŸ¦ Twitter/X"
        - "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        - "ðŸŽµ Spotify only"
        - "ðŸ“º YouTube only"
        - "ðŸ¦ Twitter/X only"
        - "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        - "ðŸŽµðŸ“ºðŸ¦ All three apps"
        required: true
        default: "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
      
      # Spotify
      spotify_config:
        description: "Spotify: version|tweak|url"
        default: "9.0.91|v6.2|https://github.com/OofMini/eeveespotifyreborn/releases/download/New/EeveeSpotify.ipa"
      
      # YouTube
      youtube_config:
        description: "YouTube: version|tweak|url"
        default: "20.44.2|v5.2b4|https://github.com/OofMini/YTLite/releases/download/New/YouTubePlus_5.2b4.ipa"
      
      # Twitter/X
      twitter_config:
        description: "Twitter/X: version|tweak|url"
        default: "11.36|v5.2|https://github.com/OofMini/tweak/releases/download/New/NeoFreeBird-sideloaded.ipa"
      
      # Options
      change_description:
        description: "Custom commit message (optional)"
        default: ""

jobs:
  repository-sync:
    name: "ðŸ”„ Sync App Repository"
    runs-on: ubuntu-latest
    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "ðŸ” Validate JSON files"
        run: |
          echo "Validating JSON file structure..."
          for file in sidestore.json feather.json trollapps.json; do
            if [ -f "$file" ]; then
              if jq empty "$file" 2>/dev/null; then
                echo "âœ… $file - Valid JSON"
              else
                echo "âŒ $file - Invalid JSON"
                exit 1
              fi
            else
              echo "âŒ $file - File not found"
              exit 1
            fi
          done

      - name: "ðŸŽ¯ Parse app selection"
        id: parse-selection
        run: |
          SELECTION="${{ inputs.app_selection }}"
          echo "Selected: $SELECTION"
          
          # Determine which apps to update based on selection
          case "$SELECTION" in
            "ðŸŽµ Spotify"|"ðŸŽµ Spotify only")
              echo "update_spotify=true" >> $GITHUB_OUTPUT
              echo "update_youtube=false" >> $GITHUB_OUTPUT
              echo "update_twitter=false" >> $GITHUB_OUTPUT
              ;;
            "ðŸ“º YouTube"|"ðŸ“º YouTube only")
              echo "update_spotify=false" >> $GITHUB_OUTPUT
              echo "update_youtube=true" >> $GITHUB_OUTPUT
              echo "update_twitter=false" >> $GITHUB_OUTPUT
              ;;
            "ðŸ¦ Twitter/X"|"ðŸ¦ Twitter/X only")
              echo "update_spotify=false" >> $GITHUB_OUTPUT
              echo "update_youtube=false" >> $GITHUB_OUTPUT
              echo "update_twitter=true" >> $GITHUB_OUTPUT
              ;;
            "ðŸŽµðŸ“ºðŸ¦ All three apps")
              echo "update_spotify=true" >> $GITHUB_OUTPUT
              echo "update_youtube=true" >> $GITHUB_OUTPUT
              echo "update_twitter=true" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "update_spotify=false" >> $GITHUB_OUTPUT
              echo "update_youtube=false" >> $GITHUB_OUTPUT
              echo "update_twitter=false" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: "ðŸ”§ Parse app configurations"
        id: parse-configs
        run: |
          # Parse Spotify config
          IFS='|' read -r spotify_version spotify_tweak spotify_url <<< "${{ inputs.spotify_config }}"
          echo "spotify_version=$spotify_version" >> $GITHUB_OUTPUT
          echo "spotify_tweak=$spotify_tweak" >> $GITHUB_OUTPUT
          echo "spotify_url=$spotify_url" >> $GITHUB_OUTPUT
          
          # Parse YouTube config
          IFS='|' read -r youtube_version youtube_tweak youtube_url <<< "${{ inputs.youtube_config }}"
          echo "youtube_version=$youtube_version" >> $GITHUB_OUTPUT
          echo "youtube_tweak=$youtube_tweak" >> $GITHUB_OUTPUT
          echo "youtube_url=$youtube_url" >> $GITHUB_OUTPUT
          
          # Parse Twitter config
          IFS='|' read -r twitter_version twitter_tweak twitter_url <<< "${{ inputs.twitter_config }}"
          echo "twitter_version=$twitter_version" >> $GITHUB_OUTPUT
          echo "twitter_tweak=$twitter_tweak" >> $GITHUB_OUTPUT
          echo "twitter_url=$twitter_url" >> $GITHUB_OUTPUT
          
          echo "âœ… Configurations parsed successfully"

      - name: "ðŸ”„ Update repository files"
        id: update-files
        run: |
          CURRENT_DATE=$(date -u +"%Y-%m-%d")
          echo "current_date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          
          # Function to update app in JSON file
          update_app_in_file() {
            local file=$1
            local app_name=$2
            local bundle_id=$3
            local version=$4
            local download_url=$5
            local tweak_version=$6
            
            echo "ðŸ”„ Updating $app_name in $file..."
            
            # Generate localized description with updated versions
            if [[ "$app_name" == "EeveeSpotify" ]]; then
              LOCALIZED_DESC="Tweaked Spotify with premium features unlocked, no ads, and enhanced playback. Spotify v$version, EeveeSpotify $tweak_version."
            elif [[ "$app_name" == "YTLite" ]]; then
              LOCALIZED_DESC="Tweaked YouTube with background playback, no ads, and picture-in-picture. Youtube v$version, YTLite $tweak_version."
            elif [[ "$app_name" == "X (NeoFreeBird)" ]]; then
              LOCALIZED_DESC="Tweaked Twitter/X with premium features and more. X v$version, NeoFreeBird $tweak_version."
            else
              # For apps without version numbers in description, keep original text
              LOCALIZED_DESC=$(jq -r --arg app "$app_name" --arg bundle "$bundle_id" '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)).localizedDescription' "$file")
            fi
            
            # Update based on file structure
            if [[ "$file" == "sidestore.json" ]]; then
              jq --arg app "$app_name" \
                 --arg bundle "$bundle_id" \
                 --arg version "$version" \
                 --arg url "$download_url" \
                 --arg desc "$LOCALIZED_DESC" \
                 --arg date "$CURRENT_DATE" \
                 '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                  .versions[0].version = $version |
                  .versions[0].downloadURL = $url |
                  .versions[0].date = $date |
                  .localizedDescription = $desc' "$file" > "${file}.tmp"
                  
            elif [[ "$file" == "feather.json" ]]; then
              jq --arg app "$app_name" \
                 --arg bundle "$bundle_id" \
                 --arg version "$version" \
                 --arg url "$download_url" \
                 --arg desc "$LOCALIZED_DESC" \
                 --arg date "$CURRENT_DATE" \
                 '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                  .version = $version |
                  .downloadURL = $url |
                  .versionDate = $date |
                  .size = (.versions[0].size) |
                  .versions[0].version = $version |
                  .versions[0].downloadURL = $url |
                  .versions[0].date = $date |
                  .localizedDescription = $desc' "$file" > "${file}.tmp"
                  
            else  # trollapps.json
              jq --arg app "$app_name" \
                 --arg bundle "$bundle_id" \
                 --arg version "$version" \
                 --arg url "$download_url" \
                 --arg desc "$LOCALIZED_DESC" \
                 '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                  .version = $version |
                  .downloadURL = $url |
                  .localizedDescription = $desc' "$file" > "${file}.tmp"
            fi
            
            mv "${file}.tmp" "$file"
          }

          UPDATED_APPS=()
          
          # Update apps based on selection
          [[ "${{ steps.parse-selection.outputs.update_spotify }}" == "true" ]] && UPDATED_APPS+=("EeveeSpotify") && for file in sidestore.json feather.json trollapps.json; do
            update_app_in_file "$file" "EeveeSpotify" "com.spotify.client" \
              "${{ steps.parse-configs.outputs.spotify_version }}" \
              "${{ steps.parse-configs.outputs.spotify_url }}" \
              "${{ steps.parse-configs.outputs.spotify_tweak }}"
          done

          [[ "${{ steps.parse-selection.outputs.update_youtube }}" == "true" ]] && UPDATED_APPS+=("YTLite") && for file in sidestore.json feather.json trollapps.json; do
            update_app_in_file "$file" "YTLite" "com.google.ios.youtube" \
              "${{ steps.parse-configs.outputs.youtube_version }}" \
              "${{ steps.parse-configs.outputs.youtube_url }}" \
              "${{ steps.parse-configs.outputs.youtube_tweak }}"
          done

          [[ "${{ steps.parse-selection.outputs.update_twitter }}" == "true" ]] && UPDATED_APPS+=("X (NeoFreeBird)") && for file in sidestore.json feather.json trollapps.json; do
            update_app_in_file "$file" "X (NeoFreeBird)" "com.atebits.Tweetie2" \
              "${{ steps.parse-configs.outputs.twitter_version }}" \
              "${{ steps.parse-configs.outputs.twitter_url }}" \
              "${{ steps.parse-configs.outputs.twitter_tweak }}"
          done

          echo "updated_apps=${UPDATED_APPS[*]}" >> $GITHUB_OUTPUT

      - name: "âœ… Verify changes"
        run: |
          echo "Verifying updated files..."
          for file in sidestore.json feather.json trollapps.json; do
            if jq empty "$file" 2>/dev/null; then
              echo "âœ… $file - Still valid after updates"
            else
              echo "âŒ $file - Became invalid after updates"
              exit 1
            fi
          done

      - name: "ðŸ“ Commit and push changes"
        if: steps.update-files.outputs.updated_apps
        run: |
          # Generate commit message
          if [[ -n "${{ inputs.change_description }}" ]]; then
            COMMIT_MSG="${{ inputs.change_description }}"
          else
            COMMIT_MSG="ðŸ”„ Repository Sync: Updated app versions across all sources"
            
            UPDATED_APPS_ARR=(${UPDATED_APPS[@]})
            if [ ${#UPDATED_APPS_ARR[@]} -gt 0 ]; then
              COMMIT_MSG+="\n\nUpdated apps:"
              for app in "${UPDATED_APPS_ARR[@]}"; do
                COMMIT_MSG+="\nâ€¢ $app"
              done
            fi
            
            COMMIT_MSG+="\n\nðŸ¤– Automated update via GitHub Actions"
          fi
          
          # Configure git and commit
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add sidestore.json feather.json trollapps.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "$(echo -e "$COMMIT_MSG")"
            git push
            echo "âœ… Changes committed and pushed successfully"
          fi

      - name: "ðŸ“Š Update summary"
        run: |
          echo "## ðŸŽ¯ Repository Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± Apps Updated:" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.update-files.outputs.updated_apps }}" ]; then
            for app in ${{ steps.update-files.outputs.updated_apps }}; do
              echo "- ðŸŽ¯ $app" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "â„¹ï¸ No apps were updated" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Files Updated:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… sidestore.json" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… feather.json" >> $GITHUB_STEP_SUMMARY  
          echo "- âœ… trollapps.json" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Automated repository management* ðŸ¤–" >> $GITHUB_STEP_SUMMARY