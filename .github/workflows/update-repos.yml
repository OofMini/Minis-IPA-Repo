name: Bulk IPA Updates

on:
  workflow_dispatch:
    inputs:
      spotify_ipa_version:
        description: "üéµ Spotify IPA Version"
        default: "9.0.96"
      spotify_tweak_version:
        description: "üéµ Spotify Tweak Version"
        default: "v6.2.2"
      youtube_ipa_version:
        description: "üì∫ YouTube IPA Version"
        default: "20.45.3"
      youtube_tweak_version:
        description: "üì∫ YouTube Tweak Version"
        default: "v5.2b4"
      x_ipa_version:
        description: "üê¶ X IPA Version"
        default: "11.38.1"
      x_tweak_version:
        description: "üê¶ X Tweak Version"
        default: "v5.2"
      change_description:
        description: "üìù Custom commit message (optional)"
        default: ""
      update_workflow_defaults:
        description: "‚öôÔ∏è Update workflow default versions"
        type: boolean
        default: true

permissions:
  contents: write
  workflows: write

jobs:
  repository-sync:
    name: "Sync App Repository"
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: "Setup dependencies"
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq
          echo "[OK] Dependencies installed"

      - name: "Validate inputs"
        run: |
          set -e
          
          # Validate version formats
          validate_version() {
            local version="$1"
            local app_name="$2"
            local version_type="$3"
            
            if [[ -z "$version" ]]; then
              echo "::error::$app_name $version_type cannot be empty"
              exit 1
            fi
            
            if [[ ! "$version" =~ ^[v]?[0-9a-z.+-]+$ ]]; then
              echo "::error::$app_name $version_type must be a valid version (e.g., '9.0.96' or 'v6.2.2'), got: $version"
              exit 1
            fi
          }
          
          validate_version "${{ github.event.inputs.spotify_ipa_version }}" "Spotify" "IPA version"
          validate_version "${{ github.event.inputs.spotify_tweak_version }}" "Spotify" "Tweak version"
          validate_version "${{ github.event.inputs.youtube_ipa_version }}" "YouTube" "IPA version"
          validate_version "${{ github.event.inputs.youtube_tweak_version }}" "YouTube" "Tweak version"
          validate_version "${{ github.event.inputs.x_ipa_version }}" "X" "IPA version"
          validate_version "${{ github.event.inputs.x_tweak_version }}" "X" "Tweak version"
          
          echo "[OK] Input validation complete"

      - name: "Process repository updates"
        id: update-files
        run: |
          set -e
          
          # Setup error handling and cleanup
          trap 'rm -f *.tmp *.bak' EXIT ERR
          
          # Get current date
          CURRENT_DATE=$(date -u +"%Y-%m-%d")
          echo "current_date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "[INFO] Processing date: $CURRENT_DATE"
          
          # Function to build download URL
          build_download_info() {
            local app_name="$1"
            local tweak_version="$2"
            
            case "$app_name" in
              "EeveeSpotify") 
                echo "https://github.com/OofMini/eeveespotifyreborn/releases/download/New/EeveeSpotify.ipa" 
                ;;
              "YTLite") 
                # Safely remove 'v' prefix if present
                local version="${tweak_version#v}"
                echo "https://github.com/OofMini/YTLite/releases/download/New/YouTubePlus_${version}.ipa" 
                ;;
              "X (NeoFreeBird)") 
                echo "https://github.com/OofMini/tweak/releases/download/New/NeoFreeBird-sideloaded.ipa" 
                ;;
              *) 
                echo "::error::Unknown app: $app_name"
                exit 1 
                ;;
            esac
          }
          
          # Validate JSON files exist and are valid
          echo "[INFO] Validating JSON files..."
          JSON_FILES=("sidestore.json" "feather.json" "trollapps.json")
          for file in "${JSON_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "::error::$file not found"
              exit 1
            fi
            
            if ! jq empty "$file" 2>/dev/null; then
              echo "::error::$file - Invalid JSON"
              exit 1
            fi
            
            if ! jq -e '.apps | type == "array"' "$file" >/dev/null 2>&1; then
              echo "::error::$file - Missing or invalid apps array"
              exit 1
            fi
            
            echo "[OK] $file - Valid JSON"
          done
          
          # Function to update app in JSON file
          update_app_in_file() {
            local file="$1" 
            local app_name="$2" 
            local bundle_id="$3" 
            local ipa_version="$4" 
            local tweak_version="$5"
            local download_url=$(build_download_info "$app_name" "$tweak_version")
            local temp_file="${file}.tmp"
            
            echo "[INFO] Updating $app_name in $file..."
            
            # Verify app exists in file
            if ! jq -e --arg app "$app_name" --arg bundle "$bundle_id" \
                 '.apps[] | select(.name == $app or .bundleIdentifier == $bundle)' \
                 "$file" >/dev/null 2>&1; then
              echo "::warning::App $app_name not found in $file, skipping..."
              return 0
            fi
            
            # Generate description based on app
            case "$app_name" in
              "EeveeSpotify") 
                local desc="Tweaked Spotify with premium features unlocked, no ads, and enhanced playback. Spotify IPA $ipa_version, EeveeSpotify $tweak_version." 
                ;;
              "YTLite") 
                local desc="Tweaked YouTube with background playback, no ads, and picture-in-picture. YouTube IPA $ipa_version, YTLite $tweak_version." 
                ;;
              "X (NeoFreeBird)") 
                local desc="Tweaked X with premium features and more. X IPA $ipa_version, NeoFreeBird $tweak_version." 
                ;;
              *) 
                # Fallback: preserve existing description
                local desc=$(jq -r --arg app "$app_name" --arg bundle "$bundle_id" \
                  '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)).localizedDescription // "Tweaked application with enhanced features."' \
                  "$file") 
                ;;
            esac
            
            # Update based on file structure
            case "$file" in
              "sidestore.json")
                jq --arg app "$app_name" \
                   --arg bundle "$bundle_id" \
                   --arg version "$ipa_version" \
                   --arg url "$download_url" \
                   --arg desc "$desc" \
                   --arg date "$CURRENT_DATE" \
                   '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                    (.versions[0].version = $version | 
                     .versions[0].downloadURL = $url | 
                     .versions[0].date = $date | 
                     .localizedDescription = $desc)' "$file" > "$temp_file"
                ;;
              "feather.json")
                jq --arg app "$app_name" \
                   --arg bundle "$bundle_id" \
                   --arg version "$ipa_version" \
                   --arg url "$download_url" \
                   --arg desc "$desc" \
                   --arg date "$CURRENT_DATE" \
                   '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                    (.version = $version | 
                     .downloadURL = $url | 
                     .versionDate = $date |
                     .versions[0].version = $version | 
                     .versions[0].downloadURL = $url | 
                     .versions[0].date = $date | 
                     .localizedDescription = $desc)' "$file" > "$temp_file"
                ;;
              "trollapps.json")
                jq --arg app "$app_name" \
                   --arg bundle "$bundle_id" \
                   --arg version "$ipa_version" \
                   --arg url "$download_url" \
                   --arg desc "$desc" \
                   '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= 
                    (.version = $version | 
                     .downloadURL = $url | 
                     .localizedDescription = $desc)' "$file" > "$temp_file"
                ;;
            esac
            
            # Verify temp file is valid JSON
            if [ ! -f "$temp_file" ]; then
              echo "::error::Failed to create temp file for $file"
              return 1
            fi
            
            if ! jq empty "$temp_file" 2>/dev/null; then
              echo "::error::Generated invalid JSON for $file"
              rm -f "$temp_file"
              return 1
            fi
            
            # Check if changes were made
            if cmp -s "$file" "$temp_file"; then
              echo "::notice::No changes needed for $app_name in $file (already up to date)"
              rm -f "$temp_file"
            else
              mv "$temp_file" "$file"
              echo "[OK] Updated $app_name in $file"
            fi
          }

          # Initialize tracking arrays
          UPDATED_APPS=()
          UPDATED_VERSIONS=()
          
          # Update Spotify
          echo ""
          echo "========================================"
          echo "Processing Spotify update..."
          echo "========================================"
          
          IPA="${{ github.event.inputs.spotify_ipa_version }}"
          TWEAK="${{ github.event.inputs.spotify_tweak_version }}"
          
          for file in "${JSON_FILES[@]}"; do
            update_app_in_file "$file" "EeveeSpotify" "com.spotify.client" "$IPA" "$TWEAK"
          done
          
          UPDATED_APPS+=("EeveeSpotify")
          UPDATED_VERSIONS+=("spotify:$IPA:$TWEAK")
          echo "[OK] Spotify processing complete"

          # Update YouTube
          echo ""
          echo "========================================"
          echo "Processing YouTube update..."
          echo "========================================"
          
          IPA="${{ github.event.inputs.youtube_ipa_version }}"
          TWEAK="${{ github.event.inputs.youtube_tweak_version }}"
          
          for file in "${JSON_FILES[@]}"; do
            update_app_in_file "$file" "YTLite" "com.google.ios.youtube" "$IPA" "$TWEAK"
          done
          
          UPDATED_APPS+=("YTLite")
          UPDATED_VERSIONS+=("youtube:$IPA:$TWEAK")
          echo "[OK] YouTube processing complete"

          # Update X
          echo ""
          echo "========================================"
          echo "Processing X update..."
          echo "========================================"
          
          IPA="${{ github.event.inputs.x_ipa_version }}"
          TWEAK="${{ github.event.inputs.x_tweak_version }}"
          
          for file in "${JSON_FILES[@]}"; do
            update_app_in_file "$file" "X (NeoFreeBird)" "com.atebits.Tweetie2" "$IPA" "$TWEAK"
          done
          
          UPDATED_APPS+=("X (NeoFreeBird)")
          UPDATED_VERSIONS+=("x:$IPA:$TWEAK")
          echo "[OK] X processing complete"

          # Output results
          echo ""
          echo "========================================"
          if [ ${#UPDATED_APPS[@]} -gt 0 ]; then
            echo "updated_apps=${UPDATED_APPS[*]}" >> $GITHUB_OUTPUT
            echo "updated_versions=${UPDATED_VERSIONS[*]}" >> $GITHUB_OUTPUT
            echo "[OK] Successfully processed: ${UPDATED_APPS[*]}"
          else
            echo "::warning::No apps were updated"
          fi
          echo "========================================"
          
          # Final validation of all JSON files
          echo ""
          echo "[INFO] Final validation..."
          for file in "${JSON_FILES[@]}"; do
            if ! jq empty "$file" 2>/dev/null; then
              echo "::error::Final validation failed for $file"
              exit 1
            fi
            echo "[OK] $file validated"
          done

      - name: "Update web files"
        if: steps.update-files.outputs.updated_versions
        run: |
          set -e
          
          UPDATED_VERSIONS_STR="${{ steps.update-files.outputs.updated_versions }}"
          
          # Safety check
          if [ -z "$UPDATED_VERSIONS_STR" ]; then
            echo "::notice::No version updates to process for web files"
            exit 0
          fi
          
          IFS=' ' read -ra VERSION_PAIRS <<< "$UPDATED_VERSIONS_STR"
          
          # Update index.html if it exists
          if [ ! -f "index.html" ]; then
            echo "::warning::index.html not found, skipping web update"
            exit 0
          fi
          
          echo "[INFO] Updating index.html..."
          
          # Create backup
          cp index.html index.html.bak
          
          # Process each version pair
          for version_pair in "${VERSION_PAIRS[@]}"; do
            IFS=':' read -ra PARTS <<< "$version_pair"
            APP="${PARTS[0]}"
            IPA_VERSION="${PARTS[1]}"
            TWEAK_VERSION="${PARTS[2]}"
            
            echo "[INFO] Updating $APP in index.html..."
            
            case "$APP" in
              "spotify")
                # Update version number
                sed -i "/id: 'eeveespotify'/,/^[[:space:]]*},/{
                  s/\(version: '\)[0-9][0-9.]*\(',\)/\1$IPA_VERSION\2/
                }" "index.html"
                
                # Update description with versions
                sed -i "/id: 'eeveespotify'/,/^[[:space:]]*},/{
                  s/\(Spotify IPA \)[0-9][0-9.]*\(, EeveeSpotify \)v\{0,1\}[0-9a-z.]*/\1$IPA_VERSION\2$TWEAK_VERSION/
                }" "index.html"
                ;;
                
              "youtube")
                # Update version number
                sed -i "/id: 'ytlite'/,/^[[:space:]]*},/{
                  s/\(version: '\)[0-9][0-9.]*\(',\)/\1$IPA_VERSION\2/
                }" "index.html"
                
                # Update description with versions
                sed -i "/id: 'ytlite'/,/^[[:space:]]*},/{
                  s/\(YouTube IPA \)[0-9][0-9.]*\(, YTLite \)v\{0,1\}[0-9a-z.]*/\1$IPA_VERSION\2$TWEAK_VERSION/
                }" "index.html"
                ;;
                
              "x")
                # Update version number
                sed -i "/id: 'neofreebird'/,/^[[:space:]]*},/{
                  s/\(version: '\)[0-9][0-9.]*\(',\)/\1$IPA_VERSION\2/
                }" "index.html"
                
                # Update description with versions
                sed -i "/id: 'neofreebird'/,/^[[:space:]]*},/{
                  s/\(X IPA \)[0-9][0-9.]*\(, NeoFreeBird \)v\{0,1\}[0-9a-z.]*/\1$IPA_VERSION\2$TWEAK_VERSION/
                }" "index.html"
                ;;
            esac
          done
          
          # Verify changes were made
          if cmp -s index.html index.html.bak; then
            echo "::warning::No changes made to index.html - patterns may not have matched"
            echo "::warning::Please verify the file structure matches expected patterns"
          else
            echo "[OK] index.html updated successfully"
          fi
          
          # Cleanup backup
          rm -f index.html.bak

      - name: "Update workflow defaults"
        if: github.event.inputs.update_workflow_defaults == 'true' && steps.update-files.outputs.updated_versions
        run: |
          set -e
          
          WORKFLOW_FILE=".github/workflows/update-repos.yml"
          
          # Check if workflow file exists
          if [ ! -f "$WORKFLOW_FILE" ]; then
            echo "::error::Workflow file not found at $WORKFLOW_FILE"
            exit 1
          fi
          
          echo "[INFO] Updating workflow default versions..."
          
          # Create backup
          cp "$WORKFLOW_FILE" "${WORKFLOW_FILE}.bak"
          
          # Get version pairs
          UPDATED_VERSIONS_STR="${{ steps.update-files.outputs.updated_versions }}"
          IFS=' ' read -ra VERSION_PAIRS <<< "$UPDATED_VERSIONS_STR"
          
          # Process each version pair
          for version_pair in "${VERSION_PAIRS[@]}"; do
            IFS=':' read -ra PARTS <<< "$version_pair"
            APP="${PARTS[0]}"
            IPA_VERSION="${PARTS[1]}"
            TWEAK_VERSION="${PARTS[2]}"
            
            case "$APP" in
              "spotify")
                echo "[INFO] Updating Spotify default versions..."
                sed -i "s/\(spotify_ipa_version:.*default: \)\"[^\"]*\"/\1\"$IPA_VERSION\"/" "$WORKFLOW_FILE"
                sed -i "s/\(spotify_tweak_version:.*default: \)\"[^\"]*\"/\1\"$TWEAK_VERSION\"/" "$WORKFLOW_FILE"
                ;;
                
              "youtube")
                echo "[INFO] Updating YouTube default versions..."
                sed -i "s/\(youtube_ipa_version:.*default: \)\"[^\"]*\"/\1\"$IPA_VERSION\"/" "$WORKFLOW_FILE"
                sed -i "s/\(youtube_tweak_version:.*default: \)\"[^\"]*\"/\1\"$TWEAK_VERSION\"/" "$WORKFLOW_FILE"
                ;;
                
              "x")
                echo "[INFO] Updating X default versions..."
                sed -i "s/\(x_ipa_version:.*default: \)\"[^\"]*\"/\1\"$IPA_VERSION\"/" "$WORKFLOW_FILE"
                sed -i "s/\(x_tweak_version:.*default: \)\"[^\"]*\"/\1\"$TWEAK_VERSION\"/" "$WORKFLOW_FILE"
                ;;
            esac
          done
          
          # Verify changes were made
          if cmp -s "$WORKFLOW_FILE" "${WORKFLOW_FILE}.bak"; then
            echo "::warning::No changes made to workflow file - defaults may already be up to date"
          else
            echo "[OK] Workflow default versions updated successfully"
          fi
          
          # Cleanup backup
          rm -f "${WORKFLOW_FILE}.bak"

      - name: "Configure Git for PAT"
        if: steps.update-files.outputs.updated_apps
        run: |
          # Configure git to use PAT for authentication
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Set up remote URL with PAT authentication
          git remote set-url origin https://${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git
          echo "[OK] Git configured for PAT authentication"

      - name: "Commit and push changes"
        if: steps.update-files.outputs.updated_apps
        run: |
          set -e
          
          # Build commit message
          if [[ -n "${{ github.event.inputs.change_description }}" ]]; then
            COMMIT_MSG="${{ github.event.inputs.change_description }}"
          else
            COMMIT_MSG="Repository Sync: Updated app versions across all sources"
            
            UPDATED_APPS_STR="${{ steps.update-files.outputs.updated_apps }}"
            if [ -n "$UPDATED_APPS_STR" ]; then
              IFS=' ' read -ra UPDATED_APPS_ARR <<< "$UPDATED_APPS_STR"
              COMMIT_MSG="$COMMIT_MSG"$'\n\n'"Updated apps:"
              for app in "${UPDATED_APPS_ARR[@]}"; do
                COMMIT_MSG="$COMMIT_MSG"$'\n'"- $app"
              done
            fi
            
            # Add version details
            UPDATED_VERSIONS_STR="${{ steps.update-files.outputs.updated_versions }}"
            if [ -n "$UPDATED_VERSIONS_STR" ]; then
              COMMIT_MSG="$COMMIT_MSG"$'\n\n'"Version details:"
              IFS=' ' read -ra VERSION_PAIRS <<< "$UPDATED_VERSIONS_STR"
              for version_pair in "${VERSION_PAIRS[@]}"; do
                IFS=':' read -ra PARTS <<< "$version_pair"
                APP_NAME="${PARTS[0]}"
                IPA_VER="${PARTS[1]}"
                TWEAK_VER="${PARTS[2]}"
                COMMIT_MSG="$COMMIT_MSG"$'\n'"- ${APP_NAME^}: IPA $IPA_VER, Tweak $TWEAK_VER"
              done
            fi
            
            # Add note about workflow defaults update
            if [[ "${{ github.event.inputs.update_workflow_defaults }}" == "true" ]]; then
              COMMIT_MSG="$COMMIT_MSG"$'\n\n'"Updated workflow default versions"
            fi
            
            COMMIT_MSG="$COMMIT_MSG"$'\n\n'"Automated update via GitHub Actions"
          fi
          
          # Stage changed files
          git add sidestore.json feather.json trollapps.json
          
          # Add index.html only if it was modified
          if [ -f index.html ] && ! git diff --quiet index.html 2>/dev/null; then
            git add index.html
          fi
          
          # Add workflow file if it was modified
          WORKFLOW_FILE=".github/workflows/update-repos.yml"
          if [ -f "$WORKFLOW_FILE" ] && ! git diff --quiet "$WORKFLOW_FILE" 2>/dev/null; then
            git add "$WORKFLOW_FILE"
            echo "[INFO] Workflow file changes staged"
          fi
          
          # Check if there are staged changes
          if git diff --staged --quiet; then
            echo "::notice::No changes to commit - files are already up to date"
            echo "no_changes=true" >> $GITHUB_OUTPUT
          else
            # Commit changes
            git commit -m "$COMMIT_MSG"
            
            # Push with retry logic using PAT authentication
            echo "[INFO] Pushing changes to repository using PAT..."
            MAX_RETRIES=3
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if git push origin HEAD; then
                echo "[OK] Changes committed and pushed successfully using PAT"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "::warning::Push failed, pulling and retrying... (Attempt $RETRY_COUNT/$MAX_RETRIES)"
                  git pull --rebase origin HEAD
                else
                  echo "::error::Failed to push after $MAX_RETRIES attempts"
                  exit 1
                fi
              fi
            done
          fi

      - name: "Generate summary"
        if: always()
        run: |
          {
            echo "## üì¶ Repository Update Summary"
            echo ""
            
            # Job status
            if [ "${{ job.status }}" == "success" ]; then
              echo "‚úÖ **Status**: Success"
            else
              echo "‚ùå **Status**: Failed"
            fi
            echo ""
            
            # Apps updated
            echo "### üì± Apps Updated:"
            UPDATED_APPS_STR="${{ steps.update-files.outputs.updated_apps }}"
            if [ -n "$UPDATED_APPS_STR" ]; then
              IFS=' ' read -ra UPDATED_APPS_ARR <<< "$UPDATED_APPS_STR"
              for app in "${UPDATED_APPS_ARR[@]}"; do
                echo "- ‚úì $app"
              done
            else
              echo "- ‚ÑπÔ∏è No apps were updated"
            fi
            
            echo ""
            echo "### üî¢ Version Details:"
            UPDATED_VERSIONS_STR="${{ steps.update-files.outputs.updated_versions }}"
            if [ -n "$UPDATED_VERSIONS_STR" ]; then
              IFS=' ' read -ra VERSION_PAIRS <<< "$UPDATED_VERSIONS_STR"
              for version_pair in "${VERSION_PAIRS[@]}"; do
                IFS=':' read -ra PARTS <<< "$version_pair"
                APP_NAME="${PARTS[0]}"
                IPA_VER="${PARTS[1]}"
                TWEAK_VER="${PARTS[2]}"
                echo "- **${APP_NAME^}**:"
                echo "  - IPA Version: \`$IPA_VER\`"
                echo "  - Tweak Version: \`$TWEAK_VER\`"
              done
            fi
            
            echo ""
            echo "### üìÑ Files Processed:"
            echo "- \`sidestore.json\`"
            echo "- \`feather.json\`"
            echo "- \`trollapps.json\`"
            echo "- \`index.html\`"
            if [[ "${{ github.event.inputs.update_workflow_defaults }}" == "true" ]]; then
              echo "- \`.github/workflows/update-repos.yml\` (workflow defaults)"
            fi
            
            echo ""
            echo "### ‚öôÔ∏è Configuration:"
            echo "- Update workflow defaults: \`${{ github.event.inputs.update_workflow_defaults }}\`"
            echo "- Authentication: PAT Token"
            
            echo ""
            echo "### ‚è∞ Execution Time:"
            echo "- Date: \`${{ steps.update-files.outputs.current_date }}\`"
            echo "- Workflow: [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            
            echo ""
            echo "---"
            echo "*Automated repository management via GitHub Actions*"
          } >> $GITHUB_STEP_SUMMARY 2>&1 || echo "::warning::Failed to write step summary"