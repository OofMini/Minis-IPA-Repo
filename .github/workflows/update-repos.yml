name: Bulk IPA Updates

on:
  workflow_dispatch:
    inputs:
      update_spotify:
        description: "Update Spotify"
        type: boolean
        default: false
      spotify_ipa_version:
        description: "Spotify IPA Version:"
        default: "9.0.91"
      spotify_tweak_version:
        description: "Spotify Tweak Version:"
        default: "v6.2"

      update_youtube:
        description: "Update YouTube"
        type: boolean
        default: false
      youtube_ipa_version:
        description: "YouTube IPA Version:"
        default: "20.44.2"
      youtube_tweak_version:
        description: "YouTube Tweak Version:"
        default: "v5.2b4"

      update_twitter:
        description: "Update Twitter/X"
        type: boolean
        default: false
      twitter_ipa_version:
        description: "Twitter IPA Version:"
        default: "11.36"
      twitter_tweak_version:
        description: "Twitter Tweak Version:"
        default: "v5.2"

      change_description:
        description: "Custom commit message (optional)"
        default: ""

jobs:
  repository-sync:
    name: Sync app repository
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate and update JSONs
        id: update-files
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y && sudo apt-get install -y jq
          CURRENT_DATE="$(date -u +"%Y-%m-%d")"
          echo "current_date=${CURRENT_DATE}" >> "$GITHUB_OUTPUT"

          files=(sidestore.json feather.json trollapps.json)
          for f in "${files[@]}"; do
            [[ -f "$f" ]] || { echo "$f missing"; exit 1; }
            jq empty "$f" >/dev/null || { echo "$f invalid JSON"; exit 1; }
            jq -e '.apps | type=="array"' "$f" >/dev/null || { echo "$f missing apps[]"; exit 1; }
          done

          build_download_info() {
            case "$1" in
              "EeveeSpotify") echo "https://github.com/OofMini/eeveespotifyreborn/releases/download/New/EeveeSpotify.ipa" ;;
              "YTLite") echo "https://github.com/OofMini/YTLite/releases/download/New/YouTubePlus_$2.ipa" ;;
              "X (NeoFreeBird)") echo "https://github.com/OofMini/tweak/releases/download/New/NeoFreeBird-sideloaded.ipa" ;;
              *) exit 1 ;;
            esac
          }

          update_app_in_file() {
            local file="$1" app="$2" bundle="$3" ipa="$4" tweak="$5"
            local url desc tmp="${file}.tmp"
            url="$(build_download_info "$app" "$tweak")"
            case "$app" in
              "EeveeSpotify") desc="Tweaked Spotify. Spotify IPA $ipa, EeveeSpotify $tweak." ;;
              "YTLite") desc="Tweaked YouTube. YouTube IPA $ipa, YTLite $tweak." ;;
              "X (NeoFreeBird)") desc="Tweaked Twitter/X. Twitter IPA $ipa, NeoFreeBird $tweak." ;;
            esac
            case "$file" in
              sidestore.json)
                jq --arg app "$app" --arg bundle "$bundle" --arg v "$ipa" --arg u "$url" --arg d "$desc" --arg date "$CURRENT_DATE" \
                  '(.apps[]|select(.name==$app or .bundleIdentifier==$bundle)) |=
                   (.versions[0].version=$v | .versions[0].downloadURL=$u | .versions[0].date=$date | .localizedDescription=$d)' "$file" >"$tmp"
                ;;
              feather.json)
                jq --arg app "$app" --arg bundle "$bundle" --arg v "$ipa" --arg u "$url" --arg d "$desc" --arg date "$CURRENT_DATE" \
                  '(.apps[]|select(.name==$app or .bundleIdentifier==$bundle)) |=
                   (.version=$v | .downloadURL=$u | .versionDate=$date | .localizedDescription=$d)' "$file" >"$tmp"
                ;;
              trollapps.json)
                jq --arg app "$app" --arg bundle "$bundle" --arg v "$ipa" --arg u "$url" --arg d "$desc" \
                  '(.apps[]|select(.name==$app or .bundleIdentifier==$bundle)) |=
                   (.version=$v | .downloadURL=$u | .localizedDescription=$d)' "$file" >"$tmp"
                ;;
            esac
            mv "$tmp" "$file"
          }

          UPDATED_APPS=()
          UPDATED_VERSIONS=()

          if [[ "${{ github.event.inputs.update_spotify }}" == "true" ]]; then
            UPDATED_APPS+=("EeveeSpotify")
            UPDATED_VERSIONS+=("spotify:${{ github.event.inputs.spotify_ipa_version }}:${{ github.event.inputs.spotify_tweak_version }}")
            for f in "${files[@]}"; do update_app_in_file "$f" "EeveeSpotify" "com.spotify.client" "${{ github.event.inputs.spotify_ipa_version }}" "${{ github.event.inputs.spotify_tweak_version }}"; done
          fi
          if [[ "${{ github.event.inputs.update_youtube }}" == "true" ]]; then
            UPDATED_APPS+=("YTLite")
            UPDATED_VERSIONS+=("youtube:${{ github.event.inputs.youtube_ipa_version }}:${{ github.event.inputs.youtube_tweak_version }}")
            for f in "${files[@]}"; do update_app_in_file "$f" "YTLite" "com.google.ios.youtube" "${{ github.event.inputs.youtube_ipa_version }}" "${{ github.event.inputs.youtube_tweak_version }}"; done
          fi
          if [[ "${{ github.event.inputs.update_twitter }}" == "true" ]]; then
            UPDATED_APPS+=("X (NeoFreeBird)")
            UPDATED_VERSIONS+=("twitter:${{ github.event.inputs.twitter_ipa_version }}:${{ github.event.inputs.twitter_tweak_version }}")
            for f in "${files[@]}"; do update_app_in_file "$f" "X (NeoFreeBird)" "com.atebits.Tweetie2" "${{ github.event.inputs.twitter_ipa_version }}" "${{ github.event.inputs.twitter_tweak_version }}"; done
          fi

          if [[ ${#UPDATED_APPS[@]} -gt 0 ]]; then
            echo "updated_apps=${UPDATED_APPS[*]}" >>"$GITHUB_OUTPUT"
            echo "updated_versions=${UPDATED_VERSIONS[*]}" >>"$GITHUB_OUTPUT"
          fi

      - name: Update index.html and workflow defaults
        if: steps.update-files.outputs.updated_versions
        shell: bash
        run: |
          set -euo pipefail
          UPDATED_VERSIONS_STR="${{ steps.update-files.outputs.updated_versions }}"
          if [[ -f index.html ]]; then
            cp index.html index.html.tmp
            IFS=' ' read -r -a arr <<< "$UPDATED_VERSIONS_STR"
            for pair in "${arr[@]}"; do
              IFS=':' read -r app ipa tweak <<< "$pair"
              case "$app" in
                spotify) sed -i -E "s/version: '9\.[0-9.]+'?/version: '${ipa}'/" index.html.tmp ;;
                youtube) sed -i -E "s/version: '20\.[0-9.]+'?/version: '${ipa}'/" index.html.tmp ;;
                twitter) sed -i -E "s/version: '11\.[0-9.]+'?/version: '${ipa}'/" index.html.tmp ;;
              esac
            done
            mv index.html.tmp index.html
          fi

          WORKFLOW_FILE=".github/workflows/${{ github.workflow }}.yml"
          [[ -f "$WORKFLOW_FILE" ]] || WORKFLOW_FILE=".github/workflows/main.yml"
          if [[ -f "$WORKFLOW_FILE" ]]; then
            cp "$WORKFLOW_FILE" "${WORKFLOW_FILE}.tmp"
            IFS=' ' read -r -a arr <<< "$UPDATED_VERSIONS_STR"
            for pair in "${arr[@]}"; do
              IFS=':' read -r app ipa tweak <<< "$pair"
              sed -i -E "s@(^[[:space:]]+${app}_ipa_version:.*default: ).*@\1\"${ipa}\"@" "${WORKFLOW_FILE}.tmp"
              sed -i -E "s@(^[[:space:]]+${app}_tweak_version:.*default: ).*@\1\"${tweak}\"@" "${WORKFLOW_FILE}.tmp"
            done
            mv "${WORKFLOW_FILE}.tmp" "$WORKFLOW_FILE"
          fi

      - name: Commit and push changes
        if: steps.update-files.outputs.updated_apps
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "${{ github.event.inputs.change_description }}" ]]; then
            COMMIT_MSG="${{ github.event.inputs.change_description }}"
          else
