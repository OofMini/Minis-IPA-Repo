name: Bulk IPA Updates - Tweaked Apps

on:
  workflow_dispatch:
    inputs:
      spotify_ipa_version:
        description: "Spotify IPA Version"
        default: "9.1.0"
        required: false
      spotify_tweak_version:
        description: "Spotify Tweak Version"
        default: "v6.2.2"
        required: false
      update_spotify:
        description: "Update Spotify"
        type: boolean
        default: true
        
      youtube_ipa_version:
        description: "YouTube IPA Version"
        default: "20.50.9"
        required: false
      youtube_tweak_version:
        description: "YouTube Tweak Version"
        default: "v5.2b4"
        required: false
      update_youtube:
        description: "Update YouTube"
        type: boolean
        default: true
        
      x_ipa_version:
        description: "X IPA Version"
        default: "11.48"
        required: false
      x_tweak_version:
        description: "X Tweak Version"
        default: "v5.2"
        required: false
      update_x:
        description: "Update X"
        type: boolean
        default: true
        
      ytmusicultimate_ipa_version:
        description: "YTMusicUltimate IPA Version"
        default: "8.50.2"
        required: false
      ytmusicultimate_tweak_version:
        description: "YTMusicUltimate Tweak Version"
        default: "2.3.1"
        required: false
      update_ytmusicultimate:
        description: "Update YTMusicUltimate"
        type: boolean
        default: true
        
      scinsta_ipa_version:
        description: "SCInsta IPA Version"
        default: "409.0.0"
        required: false
      scinsta_tweak_version:
        description: "SCInsta Tweak Version"
        default: "v0.8.0"
        required: false
      update_scinsta:
        description: "Update SCInsta"
        type: boolean
        default: true
        
      change_description:
        description: "Custom commit message (optional)"
        default: ""
        required: false
      update_workflow_defaults:
        description: "Update workflow default versions"
        type: boolean
        default: true

permissions:
  contents: write
  workflows: write

jobs:
  repository-sync:
    name: "Sync Tweaked Apps"
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: "Setup dependencies and validate inputs"
        env:
          SPOTIFY_IPA_VERSION: ${{ github.event.inputs.spotify_ipa_version }}
          SPOTIFY_TWEAK_VERSION: ${{ github.event.inputs.spotify_tweak_version }}
          UPDATE_SPOTIFY: ${{ github.event.inputs.update_spotify }}
          YOUTUBE_IPA_VERSION: ${{ github.event.inputs.youtube_ipa_version }}
          YOUTUBE_TWEAK_VERSION: ${{ github.event.inputs.youtube_tweak_version }}
          UPDATE_YOUTUBE: ${{ github.event.inputs.update_youtube }}
          X_IPA_VERSION: ${{ github.event.inputs.x_ipa_version }}
          X_TWEAK_VERSION: ${{ github.event.inputs.x_tweak_version }}
          UPDATE_X: ${{ github.event.inputs.update_x }}
          YTMUSICULTIMATE_IPA_VERSION: ${{ github.event.inputs.ytmusicultimate_ipa_version }}
          YTMUSICULTIMATE_TWEAK_VERSION: ${{ github.event.inputs.ytmusicultimate_tweak_version }}
          UPDATE_YTMUSICULTIMATE: ${{ github.event.inputs.update_ytmusicultimate }}
          SCINSTA_IPA_VERSION: ${{ github.event.inputs.scinsta_ipa_version }}
          SCINSTA_TWEAK_VERSION: ${{ github.event.inputs.scinsta_tweak_version }}
          UPDATE_SCINSTA: ${{ github.event.inputs.update_scinsta }}
        run: |
          set -e
          sudo apt-get update -qq && sudo apt-get install -y jq
          
          validate_version() {
            local version="$1"
            local app_name="$2"
            if [[ -z "$version" ]]; then echo "::error::$app_name version cannot be empty"; exit 1; fi
            
            # SECURITY FIX: Stricter validation (alphanumeric suffix only)
            if [[ ! "$version" =~ ^[v]?[0-9]+\.[0-9]+(\.[0-9]+)?(-[a-z0-9]+)?$ ]]; then
              echo "::error::$app_name version invalid (got: $version). Expected format: 1.2.3 or 1.2.3-beta1"
              exit 1
            fi

            # SECURITY FIX: Length check to prevent DoS
            if [[ ${#version} -gt 20 ]]; then
              echo "::error::$app_name version string too long"
              exit 1
            fi
          }
          
          ANY_ENABLED=false
          if [[ "$UPDATE_SPOTIFY" == "true" ]]; then ANY_ENABLED=true; validate_version "$SPOTIFY_IPA_VERSION" "Spotify"; fi
          if [[ "$UPDATE_YOUTUBE" == "true" ]]; then ANY_ENABLED=true; validate_version "$YOUTUBE_IPA_VERSION" "YouTube"; fi
          if [[ "$UPDATE_X" == "true" ]]; then ANY_ENABLED=true; validate_version "$X_IPA_VERSION" "X"; fi
          if [[ "$UPDATE_YTMUSICULTIMATE" == "true" ]]; then ANY_ENABLED=true; validate_version "$YTMUSICULTIMATE_IPA_VERSION" "YTMusic"; fi
          if [[ "$UPDATE_SCINSTA" == "true" ]]; then ANY_ENABLED=true; validate_version "$SCINSTA_IPA_VERSION" "SCInsta"; fi
          
          if [[ "$ANY_ENABLED" == "false" ]]; then echo "::notice::No apps enabled for update. Exiting."; exit 0; fi
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: "Process all repository updates"
        id: update-files
        env:
          SPOTIFY_IPA_VERSION: ${{ github.event.inputs.spotify_ipa_version }}
          SPOTIFY_TWEAK_VERSION: ${{ github.event.inputs.spotify_tweak_version }}
          UPDATE_SPOTIFY: ${{ github.event.inputs.update_spotify }}
          YOUTUBE_IPA_VERSION: ${{ github.event.inputs.youtube_ipa_version }}
          YOUTUBE_TWEAK_VERSION: ${{ github.event.inputs.youtube_tweak_version }}
          UPDATE_YOUTUBE: ${{ github.event.inputs.update_youtube }}
          X_IPA_VERSION: ${{ github.event.inputs.x_ipa_version }}
          X_TWEAK_VERSION: ${{ github.event.inputs.x_tweak_version }}
          UPDATE_X: ${{ github.event.inputs.update_x }}
          YTMUSICULTIMATE_IPA_VERSION: ${{ github.event.inputs.ytmusicultimate_ipa_version }}
          YTMUSICULTIMATE_TWEAK_VERSION: ${{ github.event.inputs.ytmusicultimate_tweak_version }}
          UPDATE_YTMUSICULTIMATE: ${{ github.event.inputs.update_ytmusicultimate }}
          SCINSTA_IPA_VERSION: ${{ github.event.inputs.scinsta_ipa_version }}
          SCINSTA_TWEAK_VERSION: ${{ github.event.inputs.scinsta_tweak_version }}
          UPDATE_SCINSTA: ${{ github.event.inputs.update_scinsta }}
          UPDATE_WORKFLOW_DEFAULTS: ${{ github.event.inputs.update_workflow_defaults }}
        run: |
          set -e
          trap 'rm -f *.tmp *.bak' EXIT ERR
          CURRENT_DATE=$(date -u +"%Y-%m-%d")
          
          APP_KEYS=("spotify" "youtube" "x" "ytmusicultimate" "scinsta")
          declare -A APP_NAMES=( ["spotify"]="EeveeSpotify" ["youtube"]="YTLite" ["x"]="NeoFreeBird" ["ytmusicultimate"]="YTMusicUltimate" ["scinsta"]="SCInsta" )
          declare -A APP_BUNDLES=( ["spotify"]="com.spotify.client" ["youtube"]="com.google.ios.youtube" ["x"]="com.atebits.Tweetie2" ["ytmusicultimate"]="com.google.ios.youtubemusic" ["scinsta"]="com.burbn.instagram" )
          declare -A APP_IDS=( ["spotify"]="eeveespotify" ["youtube"]="ytlite" ["x"]="neofreebird" ["ytmusicultimate"]="ytmusicultimate" ["scinsta"]="scinsta" )
          declare -A APP_URL_PATTERNS=(
            ["spotify"]="static:https://github.com/OofMini/eeveespotifyreborn/releases/download/New/EeveeSpotify.ipa"
            ["youtube"]="dynamic:https://github.com/OofMini/YTLite/releases/download/New/YouTubePlus_{version}.ipa"
            ["x"]="static:https://github.com/OofMini/tweak/releases/download/New/NeoFreeBird-sideloaded.ipa"
            ["ytmusicultimate"]="static:https://github.com/OofMini/YTMusicUltimate/releases/download/New/YTMusicUltimate.ipa"
            ["scinsta"]="dynamic:https://github.com/OofMini/SCInsta/releases/download/New/SCInsta_{version}.ipa"
          )
          declare -A APP_DESCRIPTIONS=(
            ["spotify"]="Tweaked Spotify with premium features unlocked, no ads, and enhanced playback. Spotify IPA %s, EeveeSpotify %s."
            ["youtube"]="Tweaked YouTube with background playback, no ads, and picture-in-picture. YouTube IPA %s, YTLite %s."
            ["x"]="Tweaked Twitter/X with premium features and more. X IPA %s, NeoFreeBird %s."
            ["ytmusicultimate"]="Tweaked YouTube Music with premium features unlocked, background playback, and no ads. Youtube Music IPA %s, YTMusicUltimate %s."
            ["scinsta"]="Tweaked Instagram premium, Instagram IPA %s, SCInsta %s"
          )
          declare -A APP_TOGGLES=( ["spotify"]="$UPDATE_SPOTIFY" ["youtube"]="$UPDATE_YOUTUBE" ["x"]="$UPDATE_X" ["ytmusicultimate"]="$UPDATE_YTMUSICULTIMATE" ["scinsta"]="$UPDATE_SCINSTA" )
          declare -A APP_IPA_VERSIONS=( ["spotify"]="$SPOTIFY_IPA_VERSION" ["youtube"]="$YOUTUBE_IPA_VERSION" ["x"]="$X_IPA_VERSION" ["ytmusicultimate"]="$YTMUSICULTIMATE_IPA_VERSION" ["scinsta"]="$SCINSTA_IPA_VERSION" )
          declare -A APP_TWEAK_VERSIONS=( ["spotify"]="$SPOTIFY_TWEAK_VERSION" ["youtube"]="$YOUTUBE_TWEAK_VERSION" ["x"]="$X_TWEAK_VERSION" ["ytmusicultimate"]="$YTMUSICULTIMATE_TWEAK_VERSION" ["scinsta"]="$SCINSTA_TWEAK_VERSION" )
          
          build_download_url() {
            local app_key="$1" tweak_version="$2" pattern="${APP_URL_PATTERNS[$app_key]}"
            if [[ "$pattern" == static:* ]]; then echo "${pattern#static:}"; elif [[ "$pattern" == dynamic:* ]]; then
              local template="${pattern#dynamic:}" version_clean="${tweak_version#v}"
              echo "${template//\{version\}/$version_clean}"
            fi
          }
          
          generate_description() {
            local app_key="$1" ipa_ver="$2" tweak_ver="$3" template="${APP_DESCRIPTIONS[$app_key]}"
            printf "$template" "$ipa_ver" "$tweak_ver"
          }
          
          update_app_in_file() {
            local file="$1" app_name="$2" bundle_id="$3" app_id="$4" ipa_ver="$5" url="$6" desc="$7" temp_file="${file}.tmp"
            
            if [ ! -f "$file" ]; then return 0; fi

            case "$file" in
              "sidestore.json") 
                  if jq -e --arg app "$app_name" --arg bundle "$bundle_id" '.apps[] | select(.name == $app or .bundleIdentifier == $bundle)' "$file" >/dev/null 2>&1; then
                    jq --arg app "$app_name" --arg bundle "$bundle_id" --arg version "$ipa_ver" --arg url "$url" --arg desc "$desc" --arg date "$CURRENT_DATE" \
                   '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= (.versions[0].version = $version | .versions[0].downloadURL = $url | .versions[0].date = $date | .localizedDescription = $desc)' "$file" > "$temp_file" 
                  fi ;;
              "trollapps.json") 
                  if jq -e --arg app "$app_name" --arg bundle "$bundle_id" '.apps[] | select(.name == $app or .bundleIdentifier == $bundle)' "$file" >/dev/null 2>&1; then
                    jq --arg app "$app_name" --arg bundle "$bundle_id" --arg version "$ipa_ver" --arg url "$url" --arg desc "$desc" --arg date "$CURRENT_DATE" \
                   '(.apps[] | select(.name == $app or .bundleIdentifier == $bundle)) |= (.version = $version | .downloadURL = $url | .localizedDescription = $desc | .versionDate = $date)' "$file" > "$temp_file" 
                  fi ;;
              "apps.json")
                  if jq -e --arg id "$app_id" '.[] | select(.id == $id)' "$file" >/dev/null 2>&1; then
                    jq --arg id "$app_id" --arg version "$ipa_ver" --arg url "$url" --arg desc "$desc" --arg date "$CURRENT_DATE" \
                      '(.[] | select(.id == $id)) |= (.version = $version | .downloadUrl = $url | .description = $desc | .date = $date)' "$file" > "$temp_file"
                  fi ;;
            esac
            
            if [ -f "$temp_file" ]; then
                if ! jq empty "$temp_file" 2>/dev/null; then 
                    echo "::error::Invalid JSON generated for $file"; rm -f "$temp_file"; return 1; 
                fi
                if ! cmp -s "$file" "$temp_file"; then 
                    mv "$temp_file" "$file"; echo "âœ… Updated $app_name in $file"; 
                else 
                    rm -f "$temp_file"; 
                fi
            fi
          }
          
          update_workflow_defaults() {
            local app_key="$1" ipa_ver="$2" tweak_ver="$3" workflow_file=".github/workflows/bulk-tweaked-apps-updates.yml"
            if [ ! -f "$workflow_file" ]; then return 0; fi
            
            # SECURITY FIX: Escape special characters in version string to prevent sed injection
            escaped_ipa=$(printf '%s\n' "$ipa_ver" | sed 's/[[\.*^$/]/\\&/g')
            escaped_tweak=$(printf '%s\n' "$tweak_ver" | sed 's/[[\.*^$/]/\\&/g')
            
            sed -i -e "/${app_key}_ipa_version:/,/default:/ s/\(default: \)\"[^\"]*\"/\1\"$escaped_ipa\"/" \
                   -e "/${app_key}_tweak_version:/,/default:/ s/\(default: \)\"[^\"]*\"/\1\"$escaped_tweak\"/" "$workflow_file"
          }
          
          JSON_FILES=("sidestore.json" "trollapps.json" "apps.json")
          UPDATED_APPS=(); UPDATED_VERSIONS=(); SKIPPED_APPS=()
          
          for app_key in "${APP_KEYS[@]}"; do
            if [[ "${APP_TOGGLES[$app_key]}" != "true" ]]; then SKIPPED_APPS+=("${APP_NAMES[$app_key]}"); continue; fi
            IPA="${APP_IPA_VERSIONS[$app_key]}"
            TWEAK="${APP_TWEAK_VERSIONS[$app_key]}"
            APP_ID="${APP_IDS[$app_key]}"
            URL=$(build_download_url "$app_key" "$TWEAK")
            DESC=$(generate_description "$app_key" "$IPA" "$TWEAK")
            
            for json_file in "${JSON_FILES[@]}"; do 
                update_app_in_file "$json_file" "${APP_NAMES[$app_key]}" "${APP_BUNDLES[$app_key]}" "$APP_ID" "$IPA" "$URL" "$DESC"
            done
            
            if [[ "$UPDATE_WORKFLOW_DEFAULTS" == "true" ]]; then update_workflow_defaults "$app_key" "$IPA" "$TWEAK"; fi
            
            UPDATED_APPS+=("${APP_NAMES[$app_key]}")
            UPDATED_VERSIONS+=("${app_key}:${IPA}:${TWEAK}")
          done
          
          if [ ${#UPDATED_APPS[@]} -gt 0 ]; then echo "updated_apps=${UPDATED_APPS[*]}" >> $GITHUB_OUTPUT; fi
          if [ ${#SKIPPED_APPS[@]} -gt 0 ]; then echo "skipped_apps=${SKIPPED_APPS[*]}" >> $GITHUB_OUTPUT; fi

      - name: "Commit and push changes"
        if: steps.update-files.outputs.updated_apps
        run: |
          set -e
          COMMIT_MSG="Repository Sync: Updated tweaked app versions"
          git add sidestore.json trollapps.json apps.json .github/workflows/bulk-tweaked-apps-updates.yml
          if ! git diff --staged --quiet; then
            git commit -m "$COMMIT_MSG"
            git push origin HEAD
          fi

      - name: "Generate summary"
        if: always()
        run: |
          echo "## ðŸ“¦ Tweaked Apps Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
