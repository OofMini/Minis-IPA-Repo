name: Bulk IPA Updates - Tweaked Apps

on:
  workflow_dispatch:
    inputs:
      spotify_ipa_version:
        description: "Spotify IPA Version"
        default: "9.1.0"
        required: false
      spotify_tweak_version:
        description: "Spotify Tweak Version"
        default: "v6.2.2"
        required: false
      update_spotify:
        description: "Update Spotify"
        type: boolean
        default: true
      youtube_ipa_version:
        description: "YouTube IPA Version"
        default: "20.50.9"
        required: false
      youtube_tweak_version:
        description: "YouTube Tweak Version"
        default: "v5.2b4"
        required: false
      update_youtube:
        description: "Update YouTube"
        type: boolean
        default: true
      x_ipa_version:
        description: "X IPA Version"
        default: "11.48"
        required: false
      x_tweak_version:
        description: "X Tweak Version"
        default: "v5.2"
        required: false
      update_x:
        description: "Update X"
        type: boolean
        default: true
      ytmusicultimate_ipa_version:
        description: "YTMusicUltimate IPA Version"
        default: "8.50.2"
        required: false
      ytmusicultimate_tweak_version:
        description: "YTMusicUltimate Tweak Version"
        default: "2.3.1"
        required: false
      update_ytmusicultimate:
        description: "Update YTMusicUltimate"
        type: boolean
        default: true
      scinsta_ipa_version:
        description: "SCInsta IPA Version"
        default: "409.0.0"
        required: false
      scinsta_tweak_version:
        description: "SCInsta Tweak Version"
        default: "v0.8.0"
        required: false
      update_scinsta:
        description: "Update SCInsta"
        type: boolean
        default: true
      change_description:
        description: "Custom commit message (optional)"
        default: ""
        required: false
      update_workflow_defaults:
        description: "Update workflow default versions (Requires PAT)"
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  repository-sync:
    name: "Sync Tweaked Apps"
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: "Run Update Script"
        id: update-files
        env:
          SPOTIFY_IPA_VERSION: ${{ github.event.inputs.spotify_ipa_version }}
          SPOTIFY_TWEAK_VERSION: ${{ github.event.inputs.spotify_tweak_version }}
          UPDATE_SPOTIFY: ${{ github.event.inputs.update_spotify }}
          YOUTUBE_IPA_VERSION: ${{ github.event.inputs.youtube_ipa_version }}
          YOUTUBE_TWEAK_VERSION: ${{ github.event.inputs.youtube_tweak_version }}
          UPDATE_YOUTUBE: ${{ github.event.inputs.update_youtube }}
          X_IPA_VERSION: ${{ github.event.inputs.x_ipa_version }}
          X_TWEAK_VERSION: ${{ github.event.inputs.x_tweak_version }}
          UPDATE_X: ${{ github.event.inputs.update_x }}
          YTMUSICULTIMATE_IPA_VERSION: ${{ github.event.inputs.ytmusicultimate_ipa_version }}
          YTMUSICULTIMATE_TWEAK_VERSION: ${{ github.event.inputs.ytmusicultimate_tweak_version }}
          UPDATE_YTMUSICULTIMATE: ${{ github.event.inputs.update_ytmusicultimate }}
          SCINSTA_IPA_VERSION: ${{ github.event.inputs.scinsta_ipa_version }}
          SCINSTA_TWEAK_VERSION: ${{ github.event.inputs.scinsta_tweak_version }}
          UPDATE_SCINSTA: ${{ github.event.inputs.update_scinsta }}
          UPDATE_WORKFLOW_DEFAULTS: ${{ github.event.inputs.update_workflow_defaults }}
        run: |
          chmod +x scripts/update_tweaked_apps.sh
          ./scripts/update_tweaked_apps.sh

      - name: "Commit and push changes"
        if: steps.update-files.outputs.updated_apps
        run: |
          set -e
          COMMIT_MSG="Repository Sync: Updated tweaked app versions"
          
          # Optimization: Removed apps.json reference
          git add sidestore.json trollapps.json
          
          if ! git diff --staged --quiet; then
            git commit -m "$COMMIT_MSG"
            # SECURITY FIX: Pull before push
            git pull --rebase origin main
            git push origin HEAD
          fi

      - name: "Generate summary"
        if: always()
        run: |
          echo "## ðŸ“¦ Tweaked Apps Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY