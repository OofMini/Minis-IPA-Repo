name: Cleanup Old Workflow Runs

on:
  schedule:
    - cron: '0 0 * * 0' # Run weekly on Sunday at midnight
  workflow_dispatch:
    inputs:
      days_to_keep:
        description: 'Days to keep (0 = delete everything from yesterday backwards)'
        required: true
        default: '0'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    
    steps:
      - name: Delete old workflow runs
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }} # <--- CRITICAL FIX: Tells gh which repo to target
          DAYS_TO_KEEP: ${{ github.event.inputs.days_to_keep || 3 }}
        run: |
          echo "ðŸ” Finding runs older than $DAYS_TO_KEEP days..."
          
          # Calculate the cutoff date
          CUTOFF_DATE=$(date -d "-$DAYS_TO_KEEP days" +%Y-%m-%d)
          echo "ðŸ“… Cutoff date: $CUTOFF_DATE"

          # Fetch list of runs to delete
          # We check specifically for 'completed' runs to avoid killing active jobs
          RUNS_TO_DELETE=$(gh run list \
            --json databaseId,createdAt,status \
            --created "<$CUTOFF_DATE" \
            --status completed \
            --limit 100 \
            --jq '.[].databaseId')
          
          # Count runs (handling empty results gracefully)
          if [ -z "$RUNS_TO_DELETE" ]; then
            echo "âœ… No runs found older than $CUTOFF_DATE. Nothing to delete."
            exit 0
          fi
          
          COUNT=$(echo "$RUNS_TO_DELETE" | wc -w)
          echo "ðŸ—‘ï¸ Found $COUNT runs to delete."

          # Loop and Delete
          for run_id in $RUNS_TO_DELETE; do
            echo "Processing Run ID: $run_id"
            gh run delete "$run_id" || echo "âš ï¸ Could not delete $run_id"
          done
          
          echo "ðŸŽ‰ Cleanup complete."
