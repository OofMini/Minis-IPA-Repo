name: Cleanup Old Workflow Runs

on:
  schedule:
    - cron: '0 0 * * 0' # Run weekly on Sunday at midnight
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    
    steps:
      - name: Delete old workflow runs
        env:
          GH_TOKEN: ${{ github.token }}
          DAYS_TO_KEEP: 3
        run: |
          echo "ğŸ” Finding runs older than $DAYS_TO_KEEP days..."
          
          # Calculate the cutoff date
          CUTOFF_DATE=$(date -d "-$DAYS_TO_KEEP days" +%Y-%m-%d)
          echo "ğŸ“… Cutoff date: $CUTOFF_DATE"

          # List runs older than the cutoff and delete them
          # --limit 100 prevents API timeouts; loop handles pagination implicitly
          gh run list \
            --json databaseId,createdAt,status \
            --created "<$CUTOFF_DATE" \
            --limit 100 \
            --jq '.[].databaseId' | while read -r run_id; do
              echo "ğŸ—‘ï¸ Deleting run ID: $run_id"
              gh run delete "$run_id" || echo "âš ï¸ Failed to delete $run_id (might be already gone)"
          done
          
          echo "âœ… Cleanup complete."