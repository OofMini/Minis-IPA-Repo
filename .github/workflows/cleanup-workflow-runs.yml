name: Cleanup Old Workflow Runs

on:
  schedule:
    - cron: '0 0 * * 0' # Weekly
  workflow_dispatch:
    inputs:
      days_to_keep:
        description: 'Days to keep (0 = delete everything from yesterday backwards)'
        required: true
        default: '0'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    
    steps:
      - name: Delete old workflow runs
        env:
          GH_TOKEN: ${{ github.token }}
          DAYS_TO_KEEP: ${{ github.event.inputs.days_to_keep || 3 }}
        run: |
          echo "üîç Finding runs older than $DAYS_TO_KEEP days..."
          
          # Calculate Cutoff
          # Note: '0 days' means anything before *right now* today is eligible if we used minutes,
          # but typically -0 days is treated strictly.
          # Let's use specific date logic for clarity.
          CUTOFF_DATE=$(date -d "-$DAYS_TO_KEEP days" +%Y-%m-%d)
          echo "üìÖ Cutoff Date: $CUTOFF_DATE"

          # Fetch list of runs to delete
          # We check specifically for 'completed' runs to avoid killing active jobs
          RUNS_TO_DELETE=$(gh run list \
            --json databaseId,createdAt,status \
            --created "<$CUTOFF_DATE" \
            --status completed \
            --limit 100 \
            --jq '.[].databaseId')
          
          # Count runs
          COUNT=$(echo "$RUNS_TO_DELETE" | wc -w)
          
          if [ -z "$RUNS_TO_DELETE" ]; then
            echo "‚úÖ No runs found older than $CUTOFF_DATE. Nothing to delete."
            exit 0
          fi

          echo "üóëÔ∏è Found $COUNT runs to delete."

          # Loop and Delete
          for run_id in $RUNS_TO_DELETE; do
            echo "Processing Run ID: $run_id"
            gh run delete "$run_id" || echo "‚ö†Ô∏è Could not delete $run_id"
          done
          
          echo "üéâ Cleanup complete."
