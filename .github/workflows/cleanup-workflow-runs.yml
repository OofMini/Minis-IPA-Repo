name: Cleanup Old Workflow Runs

on:
  schedule:
    - cron: '0 0 * * 0' # Run weekly on Sunday at midnight
  workflow_dispatch:
    inputs:
      days_to_keep:
        description: 'Days to keep (0 = delete everything from yesterday backwards)'
        required: true
        default: '0'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    
    steps:
      - name: Delete old workflow runs
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          DAYS_TO_KEEP: ${{ github.event.inputs.days_to_keep || 0 }}
        run: |
          # List of exact Workflow Names to clean
          # This ensures we check EVERY workflow, not just the most active ones
          WORKFLOWS=(
            "App Version Updates"
            "Bulk IPA Updates - Tweaked Apps"
            "Code Quality Checks"
            "Cleanup Old Workflow Runs"
            "pages-build-deployment"
          )

          # Calculate cutoff date
          CUTOFF_DATE=$(date -d "-$DAYS_TO_KEEP days" +%Y-%m-%d)
          echo "üìÖ Cutoff Date: $CUTOFF_DATE"
          echo "---------------------------------------------------"

          for workflow in "${WORKFLOWS[@]}"; do
            echo "üîç Checking workflow: '$workflow'..."
            
            # Fetch runs specific to this workflow
            # Using --limit 50 per workflow to ensure we process a good chunk
            RUNS=$(gh run list \
              --workflow "$workflow" \
              --created "<$CUTOFF_DATE" \
              --status completed \
              --json databaseId \
              --limit 50 \
              --jq '.[].databaseId')
            
            if [ -z "$RUNS" ]; then
              echo "‚úÖ No old runs found for '$workflow'."
            else
              COUNT=$(echo "$RUNS" | wc -w)
              echo "üóëÔ∏è Found $COUNT runs to delete for '$workflow'."
              
              for run_id in $RUNS; do
                gh run delete "$run_id" || echo "‚ö†Ô∏è Failed to delete $run_id"
              done
            fi
            echo "---------------------------------------------------"
          done
          
          echo "üéâ Cleanup complete."
